<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analyst Hub</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif; background: #060e1a; color: #c8dce8; min-height: 100vh; }
    ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: #0a1628; } ::-webkit-scrollbar-thumb { background: #1a3040; border-radius: 3px; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes spin { to { transform: rotate(360deg); } }
    input, textarea, select { font-family: inherit; }
    button { font-family: inherit; cursor: pointer; }
    .mono { font-family: 'JetBrains Mono', monospace; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script>
    // Global formatting utilities (outside Babel scope)
    function formatValue(val) {
      if (val == null) return "-";
      if (val >= 1e9) return "$" + (val / 1e9).toFixed(1) + "B";
      if (val >= 1e6) return "$" + (val / 1e6).toFixed(1) + "M";
      if (val >= 1e3) return "$" + (val / 1e3).toFixed(1) + "K";
      return "$" + val.toLocaleString();
    }
    function formatShares(num) {
      if (num == null) return "-";
      return num.toLocaleString();
    }
  </script>
  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback, useMemo } = React;

// ============================================================
// CONSTANTS
// ============================================================
const CUSIP_SECTOR_MAP = {
  // --- TECHNOLOGY ---
  "037833100": { ticker: "AAPL", name: "Apple Inc", sector: "Technology", industry: "Consumer Electronics" },
  "594918104": { ticker: "MSFT", name: "Microsoft Corp", sector: "Technology", industry: "Software" },
  "67066G104": { ticker: "NVDA", name: "NVIDIA Corp", sector: "Technology", industry: "Semiconductors" },
  "02079K305": { ticker: "GOOG", name: "Alphabet Inc Cl A", sector: "Technology", industry: "Internet Content" },
  "02079K107": { ticker: "GOOGL", name: "Alphabet Inc Cl C", sector: "Technology", industry: "Internet Content" },
  "30303M102": { ticker: "META", name: "Meta Platforms Inc", sector: "Technology", industry: "Internet Content" },
  "110122108": { ticker: "AVGO", name: "Broadcom Inc", sector: "Technology", industry: "Semiconductors" },
  "458140100": { ticker: "INTC", name: "Intel Corp", sector: "Technology", industry: "Semiconductors" },
  "46120E602": { ticker: "INTU", name: "Intuit Inc", sector: "Technology", industry: "Software" },
  "17275R102": { ticker: "CSCO", name: "Cisco Systems", sector: "Technology", industry: "Networking" },
  "68389X105": { ticker: "ORCL", name: "Oracle Corp", sector: "Technology", industry: "Software" },
  "79466L302": { ticker: "CRM", name: "Salesforce Inc", sector: "Technology", industry: "Software" },
  "00724F101": { ticker: "ADBE", name: "Adobe Inc", sector: "Technology", industry: "Software" },
  "872540109": { ticker: "TXN", name: "Texas Instruments", sector: "Technology", industry: "Semiconductors" },
  "035420103": { ticker: "AMAT", name: "Applied Materials", sector: "Technology", industry: "Semiconductor Equipment" },
  "553015106": { ticker: "LRCX", name: "Lam Research", sector: "Technology", industry: "Semiconductor Equipment" },
  "607059104": { ticker: "MRVL", name: "Marvell Technology", sector: "Technology", industry: "Semiconductors" },
  "49271V100": { ticker: "KLAC", name: "KLA Corp", sector: "Technology", industry: "Semiconductor Equipment" },
  // Ad Tech (Cannonball-relevant)
  "88339J105": { ticker: "TTD", name: "The Trade Desk", sector: "Technology", industry: "Ad Tech" },
  "74467Q103": { ticker: "PUBM", name: "PubMatic Inc", sector: "Technology", industry: "Ad Tech" },
  "55955D100": { ticker: "MGNI", name: "Magnite Inc", sector: "Technology", industry: "Ad Tech" },
  "226713104": { ticker: "CRTO", name: "Criteo SA", sector: "Technology", industry: "Ad Tech" },
  "25862V105": { ticker: "DV", name: "DoubleVerify Holdings", sector: "Technology", industry: "Ad Tech" },

  // --- FINANCIAL SERVICES ---
  "46625H100": { ticker: "JPM", name: "JPMorgan Chase", sector: "Financial Services", industry: "Banks" },
  "92826C839": { ticker: "V", name: "Visa Inc", sector: "Financial Services", industry: "Credit Services" },
  "571903202": { ticker: "MA", name: "Mastercard Inc", sector: "Financial Services", industry: "Credit Services" },
  "172967424": { ticker: "C", name: "Citigroup Inc", sector: "Financial Services", industry: "Banks" },
  "060505104": { ticker: "BAC", name: "Bank of America", sector: "Financial Services", industry: "Banks" },
  "949746101": { ticker: "WFC", name: "Wells Fargo", sector: "Financial Services", industry: "Banks" },
  "38141G104": { ticker: "GS", name: "Goldman Sachs", sector: "Financial Services", industry: "Capital Markets" },
  "617446448": { ticker: "MS", name: "Morgan Stanley", sector: "Financial Services", industry: "Capital Markets" },
  "902973304": { ticker: "USB", name: "U.S. Bancorp", sector: "Financial Services", industry: "Banks" },
  "808513105": { ticker: "SCHW", name: "Charles Schwab", sector: "Financial Services", industry: "Capital Markets" },
  "053015103": { ticker: "AXP", name: "American Express", sector: "Financial Services", industry: "Credit Services" },
  "74460D109": { ticker: "PYPL", name: "PayPal Holdings", sector: "Financial Services", industry: "Credit Services" },
  "084670702": { ticker: "BRK.B", name: "Berkshire Hathaway B", sector: "Financial Services", industry: "Insurance" },
  "084670108": { ticker: "BRK.A", name: "Berkshire Hathaway A", sector: "Financial Services", industry: "Insurance" },

  // --- HEALTHCARE ---
  "478160104": { ticker: "JNJ", name: "Johnson & Johnson", sector: "Healthcare", industry: "Pharmaceuticals" },
  "91324P102": { ticker: "UNH", name: "UnitedHealth Group", sector: "Healthcare", industry: "Healthcare Plans" },
  "375558103": { ticker: "GILD", name: "Gilead Sciences", sector: "Healthcare", industry: "Biotechnology" },
  "11135F101": { ticker: "BMY", name: "Bristol-Myers Squibb", sector: "Healthcare", industry: "Pharmaceuticals" },
  "00287Y109": { ticker: "ABBV", name: "AbbVie Inc", sector: "Healthcare", industry: "Pharmaceuticals" },
  "023608102": { ticker: "AMGN", name: "Amgen Inc", sector: "Healthcare", industry: "Biotechnology" },
  "464287614": { ticker: "ISRG", name: "Intuitive Surgical", sector: "Healthcare", industry: "Medical Devices" },
  "609207105": { ticker: "MRK", name: "Merck & Co", sector: "Healthcare", industry: "Pharmaceuticals" },
  "713448108": { ticker: "PFE", name: "Pfizer Inc", sector: "Healthcare", industry: "Pharmaceuticals" },
  "532457108": { ticker: "LLY", name: "Eli Lilly", sector: "Healthcare", industry: "Pharmaceuticals" },
  "260543103": { ticker: "DHR", name: "Danaher Corp", sector: "Healthcare", industry: "Diagnostics" },
  "92343E102": { ticker: "VRTX", name: "Vertex Pharma", sector: "Healthcare", industry: "Biotechnology" },
  "882508104": { ticker: "TMO", name: "Thermo Fisher", sector: "Healthcare", industry: "Life Sciences" },
  "126408103": { ticker: "CI", name: "Cigna Group", sector: "Healthcare", industry: "Healthcare Plans" },

  // --- CONSUMER CYCLICAL ---
  "023135106": { ticker: "AMZN", name: "Amazon.com Inc", sector: "Consumer Cyclical", industry: "Internet Retail" },
  "88160R101": { ticker: "TSLA", name: "Tesla Inc", sector: "Consumer Cyclical", industry: "Auto Manufacturers" },
  "437076102": { ticker: "HD", name: "Home Depot", sector: "Consumer Cyclical", industry: "Home Improvement" },
  "548661107": { ticker: "LOW", name: "Lowe's Companies", sector: "Consumer Cyclical", industry: "Home Improvement" },
  "57636Q104": { ticker: "MCD", name: "McDonald's Corp", sector: "Consumer Cyclical", industry: "Restaurants" },
  "756109104": { ticker: "RCL", name: "Royal Caribbean", sector: "Consumer Cyclical", industry: "Travel" },
  "87612E106": { ticker: "TGT", name: "Target Corp", sector: "Consumer Cyclical", industry: "Discount Stores" },
  "654106103": { ticker: "NKE", name: "Nike Inc", sector: "Consumer Cyclical", industry: "Apparel" },
  "855244109": { ticker: "SBUX", name: "Starbucks Corp", sector: "Consumer Cyclical", industry: "Restaurants" },
  "169656105": { ticker: "CMG", name: "Chipotle Mexican Grill", sector: "Consumer Cyclical", industry: "Restaurants" },
  "25754A201": { ticker: "DPZ", name: "Domino's Pizza", sector: "Consumer Cyclical", industry: "Restaurants" },
  "988498101": { ticker: "YUM", name: "Yum! Brands", sector: "Consumer Cyclical", industry: "Restaurants" },
  "518439104": { ticker: "EL", name: "Estee Lauder", sector: "Consumer Cyclical", industry: "Personal Products" },

  // --- CONSUMER DEFENSIVE ---
  "742718109": { ticker: "PG", name: "Procter & Gamble", sector: "Consumer Defensive", industry: "Household Products" },
  "931142103": { ticker: "WMT", name: "Walmart Inc", sector: "Consumer Defensive", industry: "Discount Stores" },
  "22160K105": { ticker: "COST", name: "Costco Wholesale", sector: "Consumer Defensive", industry: "Discount Stores" },
  "714046109": { ticker: "PEP", name: "PepsiCo Inc", sector: "Consumer Defensive", industry: "Beverages" },
  "191216100": { ticker: "KO", name: "Coca-Cola Co", sector: "Consumer Defensive", industry: "Beverages" },
  "194162103": { ticker: "CL", name: "Colgate-Palmolive", sector: "Consumer Defensive", industry: "Household Products" },
  "494368103": { ticker: "KMB", name: "Kimberly-Clark", sector: "Consumer Defensive", industry: "Household Products" },
  "370334104": { ticker: "GIS", name: "General Mills", sector: "Consumer Defensive", industry: "Packaged Foods" },
  "134429109": { ticker: "CPB", name: "Campbell Soup", sector: "Consumer Defensive", industry: "Packaged Foods" },
  "611740101": { ticker: "MNST", name: "Monster Beverage", sector: "Consumer Defensive", industry: "Beverages" },
  "21036P108": { ticker: "STZ", name: "Constellation Brands", sector: "Consumer Defensive", industry: "Beverages" },

  // --- COMMUNICATION SERVICES ---
  "20030N101": { ticker: "CMCSA", name: "Comcast Corp", sector: "Communication Services", industry: "Telecom" },
  "254687106": { ticker: "DIS", name: "Walt Disney Co", sector: "Communication Services", industry: "Entertainment" },
  "00206R102": { ticker: "T", name: "AT&T Inc", sector: "Communication Services", industry: "Telecom" },
  "92343V104": { ticker: "VZ", name: "Verizon Comms", sector: "Communication Services", industry: "Telecom" },
  "64110L106": { ticker: "NFLX", name: "Netflix Inc", sector: "Communication Services", industry: "Entertainment" },
  "872590104": { ticker: "TMUS", name: "T-Mobile US", sector: "Communication Services", industry: "Telecom" },
  "538034109": { ticker: "LYV", name: "Live Nation Entertainment", sector: "Communication Services", industry: "Entertainment" },
  "85210D101": { ticker: "SPOT", name: "Spotify Technology", sector: "Communication Services", industry: "Entertainment" },
  "771049103": { ticker: "RBLX", name: "Roblox Corp", sector: "Communication Services", industry: "Entertainment" },
  "934423104": { ticker: "WBD", name: "Warner Bros Discovery", sector: "Communication Services", industry: "Entertainment" },
  "92556H206": { ticker: "PARA", name: "Paramount Global", sector: "Communication Services", industry: "Entertainment" },
  "16119P108": { ticker: "CHTR", name: "Charter Communications", sector: "Communication Services", industry: "Telecom" },
  "35137L105": { ticker: "FOX", name: "Fox Corp", sector: "Communication Services", industry: "Entertainment" },

  // --- ENERGY (Sankey + Schneider relevant) ---
  "812348108": { ticker: "SLB", name: "Schlumberger", sector: "Energy", industry: "Oil Services" },
  "30231G102": { ticker: "XOM", name: "Exxon Mobil", sector: "Energy", industry: "Oil & Gas" },
  "166764100": { ticker: "CVX", name: "Chevron Corp", sector: "Energy", industry: "Oil & Gas" },
  "20825C104": { ticker: "COP", name: "ConocoPhillips", sector: "Energy", industry: "Oil & Gas" },
  "406216101": { ticker: "HAL", name: "Halliburton Co", sector: "Energy", industry: "Oil Services" },
  "26875P101": { ticker: "EOG", name: "EOG Resources", sector: "Energy", industry: "Oil & Gas" },
  "25278X109": { ticker: "FANG", name: "Diamondback Energy", sector: "Energy", industry: "Oil & Gas" },
  "25179M103": { ticker: "DVN", name: "Devon Energy", sector: "Energy", industry: "Oil & Gas" },
  "674599105": { ticker: "OXY", name: "Occidental Petroleum", sector: "Energy", industry: "Oil & Gas" },
  "56585A102": { ticker: "MPC", name: "Marathon Petroleum", sector: "Energy", industry: "Oil & Gas Refining" },
  "91913Y100": { ticker: "VLO", name: "Valero Energy", sector: "Energy", industry: "Oil & Gas Refining" },
  "718507105": { ticker: "PSX", name: "Phillips 66", sector: "Energy", industry: "Oil & Gas Refining" },
  "969457100": { ticker: "WMB", name: "Williams Companies", sector: "Energy", industry: "Oil & Gas Midstream" },
  "49456B101": { ticker: "KMI", name: "Kinder Morgan", sector: "Energy", industry: "Oil & Gas Midstream" },

  // --- INDUSTRIALS ---
  "02376R102": { ticker: "AAL", name: "American Airlines", sector: "Industrials", industry: "Airlines" },
  "245908205": { ticker: "DE", name: "Deere & Co", sector: "Industrials", industry: "Farm Machinery" },
  "149123101": { ticker: "CAT", name: "Caterpillar Inc", sector: "Industrials", industry: "Heavy Machinery" },
  "369604103": { ticker: "GE", name: "GE Aerospace", sector: "Industrials", industry: "Aerospace" },
  "539830109": { ticker: "LMT", name: "Lockheed Martin", sector: "Industrials", industry: "Aerospace & Defense" },
  "75513E101": { ticker: "RTX", name: "RTX Corp", sector: "Industrials", industry: "Aerospace & Defense" },
  "097023105": { ticker: "BA", name: "Boeing Co", sector: "Industrials", industry: "Aerospace & Defense" },
  // IronAdvisor-relevant
  "231021106": { ticker: "CMI", name: "Cummins Inc", sector: "Industrials", industry: "Industrial Machinery" },
  "693718108": { ticker: "PCAR", name: "PACCAR Inc", sector: "Industrials", industry: "Industrial Machinery" },
  "278058102": { ticker: "ETN", name: "Eaton Corp", sector: "Industrials", industry: "Industrial Machinery" },
  "773903109": { ticker: "ROK", name: "Rockwell Automation", sector: "Industrials", industry: "Industrial Machinery" },
  "701094104": { ticker: "PH", name: "Parker-Hannifin", sector: "Industrials", industry: "Industrial Machinery" },
  "260003108": { ticker: "DOV", name: "Dover Corp", sector: "Industrials", industry: "Industrial Machinery" },
  "452308109": { ticker: "ITW", name: "Illinois Tool Works", sector: "Industrials", industry: "Industrial Machinery" },
  "291011104": { ticker: "EMR", name: "Emerson Electric", sector: "Industrials", industry: "Industrial Machinery" },
  "45687V106": { ticker: "IR", name: "Ingersoll Rand", sector: "Industrials", industry: "Industrial Machinery" },
  "688239201": { ticker: "OSK", name: "Oshkosh Corp", sector: "Industrials", industry: "Industrial Machinery" },
  "001084102": { ticker: "AGCO", name: "AGCO Corp", sector: "Industrials", industry: "Farm Machinery" },

  // --- BASIC MATERIALS / CHEMICALS (Fermium-relevant) ---
  "824348106": { ticker: "SHW", name: "Sherwin-Williams", sector: "Basic Materials", industry: "Specialty Chemicals" },
  "260557103": { ticker: "DOW", name: "Dow Inc", sector: "Basic Materials", industry: "Chemicals" },
  "26614N102": { ticker: "DD", name: "DuPont de Nemours", sector: "Basic Materials", industry: "Specialty Chemicals" },
  "501585106": { ticker: "LYB", name: "LyondellBasell", sector: "Basic Materials", industry: "Chemicals" },
  "009158106": { ticker: "APD", name: "Air Products & Chemicals", sector: "Basic Materials", industry: "Specialty Chemicals" },
  "278865100": { ticker: "ECL", name: "Ecolab Inc", sector: "Basic Materials", industry: "Specialty Chemicals" },
  "693506107": { ticker: "PPG", name: "PPG Industries", sector: "Basic Materials", industry: "Specialty Chemicals" },
  "150870103": { ticker: "CE", name: "Celanese Corp", sector: "Basic Materials", industry: "Chemicals" },
  "277432100": { ticker: "EMN", name: "Eastman Chemical", sector: "Basic Materials", industry: "Specialty Chemicals" },
  "012653101": { ticker: "ALB", name: "Albemarle Corp", sector: "Basic Materials", industry: "Specialty Chemicals" },
  "670346105": { ticker: "NUE", name: "Nucor Corp", sector: "Basic Materials", industry: "Steel" },
  "858119100": { ticker: "STLD", name: "Steel Dynamics", sector: "Basic Materials", industry: "Steel" },
  "185899101": { ticker: "CLF", name: "Cleveland-Cliffs", sector: "Basic Materials", industry: "Steel" },
  "912909108": { ticker: "X", name: "United States Steel", sector: "Basic Materials", industry: "Steel" },

  // --- SOLAR / URANIUM (GLJ-relevant) ---
  "336433107": { ticker: "FSLR", name: "First Solar", sector: "Technology", industry: "Solar" },
  "29355A107": { ticker: "ENPH", name: "Enphase Energy", sector: "Technology", industry: "Solar" },
  "13321L108": { ticker: "CCJ", name: "Cameco Corp", sector: "Energy", industry: "Uranium" },
  "76954A103": { ticker: "RIVN", name: "Rivian Automotive", sector: "Consumer Cyclical", industry: "Electric Vehicles" },

  // --- AGRICULTURE / PROTEIN (Heather Jones-relevant) ---
  "902494103": { ticker: "TSN", name: "Tyson Foods", sector: "Consumer Defensive", industry: "Protein & Agriculture" },
  "039483102": { ticker: "ADM", name: "Archer-Daniels-Midland", sector: "Consumer Defensive", industry: "Protein & Agriculture" },
  "120568105": { ticker: "BG", name: "Bunge Global", sector: "Consumer Defensive", industry: "Protein & Agriculture" },
  "61945C103": { ticker: "MOS", name: "Mosaic Company", sector: "Basic Materials", industry: "Agricultural Chemicals" },
  "67077M108": { ticker: "NTR", name: "Nutrien Ltd", sector: "Basic Materials", industry: "Agricultural Chemicals" },
  "125269100": { ticker: "CF", name: "CF Industries", sector: "Basic Materials", industry: "Agricultural Chemicals" },
  "22052L104": { ticker: "CTVA", name: "Corteva Inc", sector: "Basic Materials", industry: "Agricultural Chemicals" },

  // --- UTILITIES (Schneider-relevant) ---
  "65339F101": { ticker: "NEE", name: "NextEra Energy", sector: "Utilities", industry: "Utilities - Renewable" },
  "26441C204": { ticker: "DUK", name: "Duke Energy", sector: "Utilities", industry: "Utilities - Regulated" },
  "842587107": { ticker: "SO", name: "Southern Company", sector: "Utilities", industry: "Utilities - Regulated" },
  "25746U109": { ticker: "D", name: "Dominion Energy", sector: "Utilities", industry: "Utilities - Regulated" },
  "025537101": { ticker: "AEP", name: "American Electric Power", sector: "Utilities", industry: "Utilities - Regulated" },
  "30161N101": { ticker: "EXC", name: "Exelon Corp", sector: "Utilities", industry: "Utilities - Regulated" },
  "816851109": { ticker: "SRE", name: "Sempra", sector: "Utilities", industry: "Utilities - Regulated" },

  // --- REAL ESTATE ---
  "92553P201": { ticker: "VICI", name: "VICI Properties", sector: "Real Estate", industry: "REIT" },

  // --- ETFs ---
  "78462F103": { ticker: "SPY", name: "SPDR S&P 500 ETF", sector: "ETF", industry: "Index Fund" },
  "464287622": { ticker: "IVV", name: "iShares Core S&P 500", sector: "ETF", industry: "Index Fund" },
  "922908363": { ticker: "VOO", name: "Vanguard S&P 500", sector: "ETF", industry: "Index Fund" },
  "46090E103": { ticker: "QQQ", name: "Invesco QQQ Trust", sector: "ETF", industry: "Nasdaq Index" },
};
const AFFILIATE_BRANDS = [
  {
    name: "Cannonball Research",
    shortName: "Cannonball",
    focus: "Ad Tech",
    color: "#4fc3f7",
    universal: false,
    sectors: [],
    industries: ["Ad Tech", "Internet Content"],
    tickers: ["TTD", "GOOGL", "GOOG", "META", "PUBM", "MGNI", "CRTO", "DV", "APPS", "IAS"],
    keywords: ["advertising", "ad tech", "programmatic", "digital media", "trade desk", "doubleVerify", "magnite", "pubmatic", "criteo"],
  },
  {
    name: "Fermium Research",
    shortName: "Fermium",
    focus: "Chemicals",
    color: "#dce775",
    universal: false,
    sectors: ["Basic Materials"],
    industries: ["Chemicals", "Specialty Chemicals"],
    tickers: ["DOW", "DD", "LYB", "APD", "SHW", "ECL", "PPG", "CE", "EMN", "ALB", "FMC", "HUN", "OLN", "AXTA", "RPM"],
    keywords: ["chemical", "polymer", "specialty material", "coating", "adhesive", "resin"],
  },
  {
    name: "FFTT Research",
    shortName: "FFTT",
    focus: "Macro",
    color: "#fff176",
    universal: true,
    sectors: [],
    industries: [],
    tickers: [],
    keywords: ["macro"],
  },
  {
    name: "GLJ Research",
    shortName: "GLJ",
    focus: "Solar / EVs / Steel / Uranium",
    color: "#4db6ac",
    universal: false,
    sectors: [],
    industries: ["Solar", "Electric Vehicles", "Steel", "Uranium"],
    tickers: ["FSLR", "ENPH", "SEDG", "CLF", "X", "NUE", "STLD", "CCJ", "UEC", "LEU", "TSLA", "RIVN", "LCID", "NIO", "RUN", "NOVA", "MAXN", "ARRY"],
    keywords: ["solar", "steel", "uranium", "electric vehicle", "EV battery", "photovoltaic"],
  },
  {
    name: "Heather Jones Research",
    shortName: "H. Jones",
    focus: "Protein & Agriculture",
    color: "#a1887f",
    universal: false,
    sectors: [],
    industries: ["Protein & Agriculture", "Agricultural Chemicals", "Farm Machinery", "Packaged Foods"],
    tickers: ["TSN", "ADM", "BG", "MOS", "NTR", "CF", "CTVA", "AGCO", "CALM", "PPC", "HRL", "SJM", "DE", "INGR", "DAR", "VITL"],
    keywords: ["agriculture", "protein", "farming", "fertilizer", "grain", "livestock", "poultry", "crop", "seed", "animal feed"],
  },
  {
    name: "IronAdvisor Insights",
    shortName: "IronAdvisor",
    focus: "Industrial Machinery",
    color: "#90a4ae",
    universal: false,
    sectors: [],
    industries: ["Industrial Machinery", "Heavy Machinery", "Farm Machinery"],
    tickers: ["CAT", "DE", "CMI", "PCAR", "ETN", "ROK", "PH", "DOV", "ITW", "EMR", "IR", "OSK", "TEX", "MTW", "CNHI", "AGCO"],
    keywords: ["machinery", "industrial equipment", "heavy equipment", "construction equipment", "engine", "hydraulic", "automation"],
  },
  {
    name: "LightShed Partners",
    shortName: "LightShed",
    focus: "Internet / Media / Telecom",
    color: "#ba68c8",
    universal: false,
    sectors: ["Communication Services"],
    industries: ["Telecom", "Entertainment", "Internet Content"],
    tickers: ["NFLX", "DIS", "CMCSA", "T", "VZ", "TMUS", "LYV", "SPOT", "RBLX", "WBD", "PARA", "CHTR", "FOX", "LBRDA", "SIRI", "IMAX"],
    keywords: ["media", "telecom", "streaming", "entertainment", "broadcasting", "live event", "cable", "wireless", "5G", "content"],
  },
  {
    name: "Optimal Advisory",
    shortName: "Optimal",
    focus: "Consumer",
    color: "#ffb74d",
    universal: false,
    sectors: ["Consumer Cyclical", "Consumer Defensive"],
    industries: ["Internet Retail", "Restaurants", "Home Improvement", "Discount Stores", "Beverages", "Household Products", "Apparel", "Personal Products", "Packaged Foods", "Travel"],
    tickers: ["WMT", "TGT", "COST", "NKE", "SBUX", "MCD", "DPZ", "CMG", "PG", "KO", "PEP", "EL", "CL", "KMB", "GIS", "MNST", "STZ", "YUM", "HD", "LOW", "AMZN"],
    keywords: ["consumer", "retail", "restaurant", "beverage", "food", "apparel", "household", "grocery"],
  },
  {
    name: "Rubinson Research",
    shortName: "Rubinson",
    focus: "Consumer / Brand Strategy",
    color: "#ff8a65",
    universal: false,
    sectors: ["Consumer Cyclical", "Consumer Defensive"],
    industries: ["Internet Retail", "Restaurants", "Beverages", "Household Products", "Apparel", "Personal Products", "Packaged Foods"],
    tickers: ["PG", "KO", "PEP", "NKE", "EL", "CL", "KMB", "MNST", "STZ", "MCD", "SBUX", "CMG", "META", "GOOGL", "TTD"],
    keywords: ["consumer brand", "CPG", "marketing", "brand strategy", "advertising spend", "consumer insight"],
  },
  {
    name: "Sankey Research",
    shortName: "Sankey",
    focus: "Energy",
    color: "#e57373",
    universal: false,
    sectors: ["Energy"],
    industries: ["Oil & Gas", "Oil Services", "Oil & Gas Refining", "Oil & Gas Midstream"],
    tickers: ["XOM", "CVX", "COP", "SLB", "HAL", "EOG", "FANG", "DVN", "OXY", "MPC", "VLO", "PSX", "WMB", "KMI", "BKR", "HES"],
    keywords: ["oil", "gas", "petroleum", "energy", "refining", "pipeline", "E&P", "upstream", "downstream", "midstream", "LNG"],
  },
  {
    name: "The Schneider Capital Group",
    shortName: "Schneider",
    focus: "Energy & Utilities",
    color: "#ef5350",
    universal: false,
    sectors: ["Energy", "Utilities"],
    industries: ["Oil & Gas", "Oil Services", "Oil & Gas Refining", "Oil & Gas Midstream", "Utilities - Renewable", "Utilities - Regulated", "Uranium"],
    tickers: ["XOM", "CVX", "COP", "SLB", "EOG", "FANG", "NEE", "DUK", "SO", "D", "AEP", "EXC", "SRE", "DVN", "OXY", "MPC", "VLO", "CCJ"],
    keywords: ["energy", "utilities", "power", "electricity", "natural gas", "renewable", "nuclear"],
  },
];
const SAMPLE_FIRMS = [
  // --- MAJOR HEDGE FUNDS ---
  { name: "BRIDGEWATER ASSOCIATES, LP", cik: "0001350694", type: "Hedge Fund" },
  { name: "CITADEL ADVISORS LLC", cik: "0001423053", type: "Hedge Fund" },
  { name: "MILLENNIUM MANAGEMENT LLC", cik: "0001273087", type: "Hedge Fund" },
  { name: "TWO SIGMA INVESTMENTS, LP", cik: "0001179392", type: "Hedge Fund" },
  { name: "D. E. SHAW & CO., L.P.", cik: "0001009207", type: "Hedge Fund" },
  { name: "RENAISSANCE TECHNOLOGIES LLC", cik: "0001037389", type: "Hedge Fund" },
  { name: "AQR CAPITAL MANAGEMENT LLC", cik: "0001167557", type: "Hedge Fund" },
  { name: "POINT72 ASSET MANAGEMENT, L.P.", cik: "0001603466", type: "Hedge Fund" },
  { name: "ELLIOTT INVESTMENT MANAGEMENT L.P.", cik: "0001048445", type: "Hedge Fund" },
  { name: "BAUPOST GROUP LLC", cik: "0001061768", type: "Hedge Fund" },
  { name: "VIKING GLOBAL INVESTORS LP", cik: "0001103804", type: "Hedge Fund" },
  { name: "LONE PINE CAPITAL LLC", cik: "0001061165", type: "Hedge Fund" },
  { name: "COATUE MANAGEMENT LLC", cik: "0001535392", type: "Hedge Fund" },
  { name: "TIGER GLOBAL MANAGEMENT LLC", cik: "0001167483", type: "Hedge Fund" },
  { name: "PERSHING SQUARE CAPITAL MANAGEMENT, L.P.", cik: "0001336528", type: "Hedge Fund" },
  { name: "THIRD POINT LLC", cik: "0001040273", type: "Hedge Fund" },
  { name: "SOROS FUND MANAGEMENT LLC", cik: "0001029160", type: "Hedge Fund" },
  { name: "APPALOOSA MANAGEMENT LP", cik: "0001656456", type: "Hedge Fund" },
  { name: "GREENLIGHT CAPITAL INC", cik: "0001079114", type: "Hedge Fund" },
  { name: "VALUEACT CAPITAL MANAGEMENT, L.P.", cik: "0001345471", type: "Hedge Fund" },
  { name: "JANA PARTNERS LLC", cik: "0001325863", type: "Hedge Fund" },
  { name: "STARBOARD VALUE LP", cik: "0001517137", type: "Hedge Fund" },
  { name: "MAVERICK CAPITAL, LTD.", cik: "0001010463", type: "Hedge Fund" },
  { name: "FARALLON CAPITAL MANAGEMENT, L.L.C.", cik: "0001022820", type: "Hedge Fund" },
  { name: "CANYON CAPITAL ADVISORS LLC", cik: "0001094696", type: "Hedge Fund" },
  { name: "BALYASNY ASSET MANAGEMENT LLC", cik: "0001396814", type: "Hedge Fund" },
  { name: "MOORE CAPITAL MANAGEMENT, LP", cik: "0001044316", type: "Hedge Fund" },
  { name: "PAULSON & CO. INC.", cik: "0001035674", type: "Hedge Fund" },
  { name: "TIGER MANAGEMENT LLC", cik: "0001013282", type: "Hedge Fund" },
  { name: "BRIGADE CAPITAL MANAGEMENT, LP", cik: "0001547341", type: "Hedge Fund" },
  { name: "MARSHALL WACE LLP", cik: "0001530266", type: "Hedge Fund" },
  { name: "SCULPTOR CAPITAL MANAGEMENT INC", cik: "0001403256", type: "Hedge Fund" },
  { name: "CAXTON ASSOCIATES LP", cik: "0001104012", type: "Hedge Fund" },
  { name: "OMEGA ADVISORS INC.", cik: "0001061219", type: "Hedge Fund" },
  { name: "TRIAN FUND MANAGEMENT, L.P.", cik: "0001547341", type: "Activist" },
  { name: "ICAHN CARL C", cik: "0000921669", type: "Activist" },

  // --- MAJOR ASSET MANAGERS ---
  { name: "BLACKROCK INC.", cik: "0001364742", type: "Asset Manager" },
  { name: "VANGUARD GROUP INC", cik: "0000102909", type: "Asset Manager" },
  { name: "STATE STREET CORP", cik: "0000093751", type: "Asset Manager" },
  { name: "FIDELITY MANAGEMENT & RESEARCH CO LLC", cik: "0000315066", type: "Asset Manager" },
  { name: "CAPITAL WORLD INVESTORS", cik: "0000225648", type: "Asset Manager" },
  { name: "GEODE CAPITAL MANAGEMENT, LLC", cik: "0001214717", type: "Asset Manager" },
  { name: "INVESCO LTD.", cik: "0000914208", type: "Asset Manager" },
  { name: "T. ROWE PRICE ASSOCIATES, INC.", cik: "0001035267", type: "Asset Manager" },
  { name: "WELLINGTON MANAGEMENT GROUP LLP", cik: "0001624313", type: "Asset Manager" },
  { name: "DIMENSIONAL FUND ADVISORS LP", cik: "0000354204", type: "Asset Manager" },
  { name: "NORTHERN TRUST CORP", cik: "0000073124", type: "Asset Manager" },
  { name: "FRANKLIN RESOURCES INC", cik: "0000038777", type: "Asset Manager" },
  { name: "MFS INVESTMENT MANAGEMENT", cik: "0001292829", type: "Asset Manager" },
  { name: "NUVEEN ASSET MANAGEMENT LLC", cik: "0001471690", type: "Asset Manager" },
  { name: "ALLIANCEBERNSTEIN L.P.", cik: "0000825313", type: "Asset Manager" },
  { name: "JANUS HENDERSON GROUP PLC", cik: "0001064642", type: "Asset Manager" },
  { name: "DODGE & COX", cik: "0000029102", type: "Asset Manager" },
  { name: "HARRIS ASSOCIATES L.P.", cik: "0000797530", type: "Asset Manager" },
  { name: "LOOMIS SAYLES & COMPANY, L.P.", cik: "0000060481", type: "Asset Manager" },
  { name: "PUTNAM INVESTMENTS LLC", cik: "0000789399", type: "Asset Manager" },
  { name: "ARK INVESTMENT MANAGEMENT LLC", cik: "0001697748", type: "Asset Manager" },
  { name: "AMERICAN CENTURY COMPANIES INC", cik: "0001002545", type: "Asset Manager" },
  { name: "LAZARD ASSET MANAGEMENT LLC", cik: "0001062005", type: "Asset Manager" },
  { name: "EATON VANCE MANAGEMENT", cik: "0000350797", type: "Asset Manager" },

  // --- BANKS / BROKER-DEALERS ---
  { name: "JPMORGAN CHASE & CO", cik: "0000019617", type: "Bank" },
  { name: "GOLDMAN SACHS GROUP INC", cik: "0000886982", type: "Bank" },
  { name: "MORGAN STANLEY", cik: "0000895421", type: "Bank" },
  { name: "CHARLES SCHWAB INVESTMENT MANAGEMENT INC", cik: "0000803588", type: "Bank" },
  { name: "UBS GROUP AG", cik: "0001610520", type: "Bank" },
  { name: "BARCLAYS PLC", cik: "0000312069", type: "Bank" },

  // --- INSURANCE / PENSION ---
  { name: "PRUDENTIAL FINANCIAL INC", cik: "0001137774", type: "Insurance" },
  { name: "PRINCIPAL FINANCIAL GROUP INC", cik: "0001126328", type: "Insurance" },

  // --- GROWTH / TECH-FOCUSED ---
  { name: "DRAGONEER INVESTMENT GROUP LLC", cik: "0001571906", type: "Hedge Fund" },
  { name: "WHALE ROCK CAPITAL MANAGEMENT LLC", cik: "0001604369", type: "Hedge Fund" },
  { name: "ALTIMETER CAPITAL MANAGEMENT, LP", cik: "0001617631", type: "Hedge Fund" },
  { name: "D1 CAPITAL PARTNERS L.P.", cik: "0001787519", type: "Hedge Fund" },
  { name: "LIGHT STREET CAPITAL MANAGEMENT, LLC", cik: "0001623822", type: "Hedge Fund" },
  { name: "ALKEON CAPITAL MANAGEMENT LLC", cik: "0001541996", type: "Hedge Fund" },
  { name: "SOROBAN CAPITAL PARTNERS LP", cik: "0001550950", type: "Hedge Fund" },

  // --- ENERGY-FOCUSED (Sankey/Schneider-relevant) ---
  { name: "KING STREET CAPITAL MANAGEMENT, L.P.", cik: "0001106500", type: "Hedge Fund" },
  { name: "ANCHORAGE CAPITAL GROUP, L.L.C.", cik: "0001279833", type: "Hedge Fund" },

  // --- MULTI-STRATEGY ---
  { name: "APOLLO MANAGEMENT HOLDINGS, L.P.", cik: "0001411494", type: "Hedge Fund" },
  { name: "KKR & CO INC", cik: "0001404912", type: "Hedge Fund" },

  // --- SOUTHEASTERN / VALUE ---
  { name: "SOUTHEASTERN ASSET MANAGEMENT INC", cik: "0000807985", type: "Asset Manager" },
  { name: "BRANDES INVESTMENT PARTNERS, L.P.", cik: "0000783412", type: "Asset Manager" },
];
const STOCK_PRICES = {
  "037833100":230,"594918104":420,"67066G104":140,"02079K305":175,"02079K107":176,
  "30303M102":580,"110122108":185,"458140100":22,"46120E602":620,"17275R102":57,
  "68389X105":175,"79466L302":300,"00724F101":480,"872540109":195,"88339J105":110,
  "74467Q103":18,"55955D100":15,"226713104":38,"25862V105":18,
  "46625H100":240,"92826C839":295,"571903202":520,"172967424":72,"060505104":43,
  "949746101":70,"38141G104":580,"617446448":115,"808513105":78,"053015103":280,
  "74460D109":80,"084670702":460,
  "478160104":155,"91324P102":510,"375558103":95,"11135F101":42,"00287Y109":170,
  "023608102":290,"464287614":520,"609207105":100,"713448108":26,"532457108":780,
  "260543103":240,"92343E102":440,"882508104":560,
  "023135106":210,"88160R101":350,"931142103":90,"742718109":170,"191216100":62,
  "654106103":75,"58933Y105":300,"812085204":100,
  "20825C104":105,"30231G102":108,"166764100":155,"674599105":52,
  "64110L106":900,"252131107":110,"92343V104":42,"78410G104":490,
  "099724106":180,"912456100":130,"149123101":380,"369604103":185,"443185106":200,
  "345370860":175
};

function seededRandom(seed) {
  let s = seed;
  return function() {
    s = (s * 1664525 + 1013904223) & 0xFFFFFFFF;
    return (s >>> 0) / 0xFFFFFFFF;
  };
}

function generateSampleHoldings(firm) {
  // Create a seed from CIK
  const cikNum = parseInt(firm.cik.replace(/^0+/, "")) || 12345;
  const rand = seededRandom(cikNum);

  const allCusips = Object.keys(CUSIP_SECTOR_MAP);
  const sectors = {};
  allCusips.forEach(c => {
    const s = CUSIP_SECTOR_MAP[c].sector;
    if (!sectors[s]) sectors[s] = [];
    sectors[s].push(c);
  });

  // Sector weights by firm name/type for realistic portfolios
  let weights = { "Technology": 0.30, "Financial Services": 0.15, "Healthcare": 0.15,
    "Consumer Cyclical": 0.10, "Consumer Defensive": 0.05, "Energy": 0.08,
    "Communication Services": 0.07, "Industrials": 0.05, "Utilities": 0.03, "Real Estate": 0.02 };
  let numHoldings = 45;
  let baseVal = 3000000; // in thousands

  const nm = firm.name.toUpperCase();
  // Tech-heavy funds
  if (nm.includes("TIGER") || nm.includes("COATUE") || nm.includes("LONE PINE")) {
    weights = { "Technology": 0.55, "Communication Services": 0.15, "Consumer Cyclical": 0.12,
      "Healthcare": 0.08, "Financial Services": 0.05, "Industrials": 0.03, "Energy": 0.02 };
    numHoldings = 28; baseVal = 5000000;
  }
  // Concentrated activists
  else if (nm.includes("PERSHING") || nm.includes("VALUEACT") || nm.includes("ELLIOTT") || nm.includes("THIRD POINT") || nm.includes("STARBOARD") || nm.includes("JANA")) {
    weights = { "Technology": 0.25, "Industrials": 0.20, "Healthcare": 0.15,
      "Consumer Cyclical": 0.15, "Financial Services": 0.10, "Energy": 0.10, "Communication Services": 0.05 };
    numHoldings = 18; baseVal = 4000000;
  }
  // Quant / multi-strat
  else if (nm.includes("CITADEL") || nm.includes("DE SHAW") || nm.includes("TWO SIGMA") || nm.includes("RENAISSANCE") || nm.includes("MILLENNIUM") || nm.includes("AQR") || nm.includes("BALYASNY")) {
    weights = { "Technology": 0.35, "Financial Services": 0.18, "Healthcare": 0.15,
      "Consumer Cyclical": 0.10, "Energy": 0.07, "Industrials": 0.07, "Communication Services": 0.05, "Consumer Defensive": 0.03 };
    numHoldings = 55; baseVal = 4500000;
  }
  // Macro / diversified
  else if (nm.includes("BRIDGEWATER") || nm.includes("SOROS") || nm.includes("MOORE")) {
    weights = { "Technology": 0.20, "Financial Services": 0.20, "Healthcare": 0.12,
      "Consumer Defensive": 0.12, "Energy": 0.10, "Consumer Cyclical": 0.08, "Industrials": 0.08, "Communication Services": 0.05, "Utilities": 0.03, "Real Estate": 0.02 };
    numHoldings = 50; baseVal = 3500000;
  }
  // Energy-focused (Sankey/Schneider relevant)
  else if (nm.includes("ENERGY") || nm.includes("CANYON")) {
    weights = { "Energy": 0.40, "Industrials": 0.15, "Financial Services": 0.15,
      "Technology": 0.10, "Healthcare": 0.10, "Consumer Cyclical": 0.05, "Utilities": 0.05 };
    numHoldings = 25; baseVal = 2000000;
  }
  // Giant asset managers
  else if (nm.includes("BLACKROCK") || nm.includes("VANGUARD") || nm.includes("STATE STREET") || nm.includes("FIDELITY")) {
    weights = { "Technology": 0.30, "Financial Services": 0.15, "Healthcare": 0.14,
      "Consumer Cyclical": 0.10, "Industrials": 0.08, "Communication Services": 0.07, "Energy": 0.06, "Consumer Defensive": 0.05, "Utilities": 0.03, "Real Estate": 0.02 };
    numHoldings = 65; baseVal = 40000000;
  }
  // Other asset managers
  else if (firm.type === "Asset Manager") {
    numHoldings = 40; baseVal = 8000000;
  }
  // Value / distressed
  else if (nm.includes("BAUPOST") || nm.includes("APPALOOSA") || nm.includes("GREENLIGHT") || nm.includes("PAULSON")) {
    weights = { "Financial Services": 0.22, "Healthcare": 0.18, "Energy": 0.18,
      "Technology": 0.15, "Industrials": 0.12, "Consumer Cyclical": 0.08, "Communication Services": 0.07 };
    numHoldings = 22; baseVal = 2500000;
  }

  // Build pool of cusips weighted by sector
  let pool = [];
  for (const [sector, w] of Object.entries(weights)) {
    const sectorCusips = sectors[sector] || [];
    if (sectorCusips.length > 0) {
      const count = Math.max(1, Math.round(numHoldings * w));
      // Shuffle sector cusips using seeded random
      const shuffled = [...sectorCusips].sort(() => rand() - 0.5);
      pool.push(...shuffled.slice(0, count));
    }
  }
  // Remove duplicates, trim to numHoldings
  pool = [...new Set(pool)].slice(0, numHoldings);

  // Assign values with exponential decay + noise
  let val = baseVal;
  const decay = 0.88;
  const holdings = pool.map(cusip => {
    const mapped = CUSIP_SECTOR_MAP[cusip];
    const price = STOCK_PRICES[cusip] || 100;
    const noise = 0.7 + rand() * 0.6; // 0.7-1.3
    const thisVal = Math.round(val * noise);
    val *= decay;
    const shares = Math.round(thisVal * 1000 / price);
    return {
      nameOfIssuer: mapped.name, titleOfClass: "COM", cusip: cusip,
      value: thisVal,
      shrsOrPrnAmt: { sshPrnamt: shares, sshPrnamtType: "SH" },
      investmentDiscretion: "SOLE",
      votingAuthority: { sole: shares, shared: 0, none: 0 }
    };
  });

  holdings.sort((a, b) => b.value - a.value);
  return {
    holdings,
    filingInfo: {
      filingDate: "2025-11-14", reportDate: "2025-09-30",
      accession: "sample-data", entityName: firm.name,
      source: "sample"
    }
  };
}
const SECTOR_COLORS = {
  "Technology": "#4fc3f7",
  "Financial Services": "#81c784",
  "Healthcare": "#f06292",
  "Consumer Cyclical": "#ffb74d",
  "Consumer Defensive": "#a1887f",
  "Communication Services": "#ba68c8",
  "Industrials": "#90a4ae",
  "Energy": "#e57373",
  "Basic Materials": "#dce775",
  "Real Estate": "#4db6ac",
  "Utilities": "#fff176",
  "ETF": "#78909c",
  "Unknown": "#546e7a",
};

// Formatting utilities (defined in global script block above)

// ============================================================
// COVERAGE OVERLAP SCORING ENGINE
// ============================================================
function calculateBrandOverlap(holdings, brand) {
  if (brand.universal) {
    return {
      brand: brand.name,
      shortName: brand.shortName,
      focus: brand.focus,
      color: brand.color,
      score: 100,
      matchedValue: 0,
      matchedCount: 0,
      totalValue: 0,
      relevance: "High",
      reason: "Universal macro research — relevant to all institutional investors",
      matchedHoldings: [],
    };
  }

  let matchedValue = 0;
  let matchedCount = 0;
  const matchedHoldings = [];
  const totalValue = holdings.reduce((s, h) => s + h.value, 0);

  holdings.forEach(h => {
    const mapped = CUSIP_SECTOR_MAP[h.cusip];
    let matched = false;
    let matchType = "";

    if (mapped) {
      if (brand.tickers.includes(mapped.ticker)) {
        matched = true;
        matchType = "ticker";
      }
      else if (brand.industries.length > 0 && brand.industries.includes(mapped.industry)) {
        matched = true;
        matchType = "industry";
      }
      else if (brand.sectors.length > 0 && brand.sectors.includes(mapped.sector)) {
        matched = true;
        matchType = "sector";
      }
    }

    if (!matched && brand.keywords.length > 0) {
      const issuerLower = h.nameOfIssuer.toLowerCase();
      const industryLower = mapped?.industry?.toLowerCase() || "";
      if (brand.keywords.some(kw => issuerLower.includes(kw.toLowerCase()) || industryLower.includes(kw.toLowerCase()))) {
        matched = true;
        matchType = "keyword";
      }
    }

    if (matched) {
      matchedValue += h.value;
      matchedCount++;
      matchedHoldings.push({
        ...h,
        ticker: mapped?.ticker,
        sector: mapped?.sector,
        industry: mapped?.industry,
        matchType,
      });
    }
  });

  const valueScore = totalValue > 0 ? (matchedValue / totalValue) * 100 : 0;
  const countScore = holdings.length > 0 ? (matchedCount / holdings.length) * 100 : 0;
  const score = totalValue > 0 ? valueScore : countScore;

  let relevance, reason;
  if (score > 12) {
    relevance = "High";
    reason = `${score.toFixed(1)}% of portfolio in ${brand.focus} — strong alignment`;
  } else if (score > 4) {
    relevance = "Medium";
    reason = `${score.toFixed(1)}% exposure to ${brand.focus} — meaningful position`;
  } else if (matchedCount > 0) {
    relevance = "Low";
    reason = `${matchedCount} position${matchedCount > 1 ? "s" : ""} in ${brand.focus} — limited but present`;
  } else {
    relevance = "None";
    reason = `No identified exposure to ${brand.focus}`;
  }

  return {
    brand: brand.name,
    shortName: brand.shortName,
    focus: brand.focus,
    color: brand.color,
    score,
    matchedValue: matchedValue * 1000,
    matchedCount,
    totalValue: totalValue * 1000,
    relevance,
    reason,
    matchedHoldings: matchedHoldings.sort((a, b) => b.value - a.value).slice(0, 5),
  };
}

function calculateAllOverlaps(holdings) {
  return AFFILIATE_BRANDS.map(brand => calculateBrandOverlap(holdings, brand))
    .sort((a, b) => {
      const order = { High: 0, Medium: 1, Low: 2, None: 3 };
      if (order[a.relevance] !== order[b.relevance]) return order[a.relevance] - order[b.relevance];
      return b.score - a.score;
    });
}

// ============================================================
// PASSWORD (SHA-256 of "analysthub")
// ============================================================
const PASSWORD_HASH = "6371cef2189d3b82acf7e5f7054fd0fae6a62b909ae029bfb08ea4b5933cb596";

async function hashPassword(pw) {
  const enc = new TextEncoder().encode(pw);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, "0")).join("");
}

// ============================================================
// DATA LAYER (localStorage)
// ============================================================
const DB_KEY = "analyst_hub_data";
const EMPTY_DB = { salespeople: [], accounts: [], campaigns: [] };

function loadData() {
  try {
    const raw = localStorage.getItem(DB_KEY);
    if (!raw) return { ...EMPTY_DB };
    const d = JSON.parse(raw);
    return { salespeople: d.salespeople || [], accounts: d.accounts || [], campaigns: d.campaigns || [] };
  } catch { return { ...EMPTY_DB }; }
}

function saveData(data) {
  localStorage.setItem(DB_KEY, JSON.stringify(data));
}

function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
}

// ============================================================
// SEC EDGAR FETCH (stateless version)
// ============================================================
const secFetch = async (secUrl) => {
  const res = await fetch(`/api/edgar?url=${encodeURIComponent(secUrl)}`);
  if (!res.ok) throw new Error(`SEC proxy error (${res.status})`);
  return res;
};

const fetchHoldingsLive = async (cik) => {
  const cikPadded = cik.replace(/^0+/, "").padStart(10, "0");
  const subRes = await secFetch(`https://data.sec.gov/submissions/CIK${cikPadded}.json`);
  const subData = await subRes.json();
  const recentFilings = subData.filings?.recent;
  if (!recentFilings) throw new Error("No filing data found");

  let filingIdx = -1;
  for (let i = 0; i < recentFilings.form.length; i++) {
    if (recentFilings.form[i] === "13F-HR") { filingIdx = i; break; }
  }
  if (filingIdx === -1) throw new Error("No 13F-HR filing found");

  const accession = recentFilings.accessionNumber[filingIdx].replace(/-/g, "");
  const accessionFormatted = recentFilings.accessionNumber[filingIdx];
  const filingInfo = {
    filingDate: recentFilings.filingDate[filingIdx],
    reportDate: recentFilings.reportDate?.[filingIdx] || recentFilings.filingDate[filingIdx],
    accession: accessionFormatted,
    entityName: subData.name, entityType: subData.entityType,
    sic: subData.sic, sicDescription: subData.sicDescription,
  };

  const cikClean = cik.replace(/^0+/, "");
  const indexRes = await secFetch(`https://www.sec.gov/Archives/edgar/data/${cikClean}/${accession}/`);
  const indexHtml = await indexRes.text();
  const xmlMatch = indexHtml.match(/href="([^"]*(?:informationtable|infotable|information_table|13f)[^"]*\.xml)"/i);
  if (!xmlMatch) throw new Error("Could not locate 13F XML in filing index");

  const xmlUrl = xmlMatch[1].startsWith('/') || xmlMatch[1].startsWith('http')
    ? `https://www.sec.gov${xmlMatch[1].startsWith('http') ? new URL(xmlMatch[1]).pathname : xmlMatch[1]}`
    : `https://www.sec.gov/Archives/edgar/data/${cikClean}/${accession}/${xmlMatch[1]}`;
  const xmlRes = await secFetch(xmlUrl);
  const xmlText = await xmlRes.text();

  const parsedHoldings = [];
  const allElements = xmlText.split(/<\/(?:ns1:)?infoTable>/i);
  for (const block of allElements) {
    const getName = (tag) => {
      const regex = new RegExp(`<(?:ns1:)?${tag}>([^<]+)<`, "i");
      const m = block.match(regex);
      return m ? m[1].trim() : null;
    };
    const issuer = getName("nameOfIssuer");
    if (!issuer) continue;
    parsedHoldings.push({
      nameOfIssuer: issuer, titleOfClass: getName("titleOfClass") || "",
      cusip: getName("cusip") || "", value: parseInt(getName("value") || "0"),
      shrsOrPrnAmt: { sshPrnamt: parseInt(getName("sshPrnamt") || "0"), sshPrnamtType: getName("sshPrnamtType") || "SH" },
      investmentDiscretion: getName("investmentDiscretion") || "",
      votingAuthority: { sole: parseInt(getName("Sole") || "0"), shared: parseInt(getName("Shared") || "0"), none: parseInt(getName("None") || "0") },
    });
  }
  parsedHoldings.sort((a, b) => b.value - a.value);
  return { holdings: parsedHoldings, filingInfo };
};

// Fetch with sample data fallback
const fetchAccountHoldings = async (account) => {
  try {
    const result = await fetchHoldingsLive(account.cik);
    return result;
  } catch (e) {
    console.log("Live SEC fetch failed, using sample data:", e.message);
    const firm = { name: account.name, cik: account.cik, type: account.type || "Hedge Fund" };
    return generateSampleHoldings(firm);
  }
};

// ============================================================
// CSV IMPORTER
// ============================================================
function CSVImporter({ onImport, onClose }) {
  const [csvText, setCsvText] = useState("");
  const [preview, setPreview] = useState(null);
  const [error, setError] = useState("");
  const fileRef = useRef(null);

  const parseCSV = (text) => {
    const lines = text.split("\n").filter(l => l.trim());
    if (lines.length < 2) throw new Error("CSV must have a header row and at least one data row");
    const rawHeaders = lines[0].split(",").map(h => h.trim().replace(/^["']|["']$/g, ""));
    const headers = rawHeaders.map(h => h.toLowerCase());

    // Required: salesperson, account_name, cik
    const spIdx = headers.findIndex(h => h.includes("salesperson") || h.includes("sales_person") || h.includes("rep"));
    const nameIdx = headers.findIndex(h => h.includes("account") || h.includes("firm") || h.includes("company"));
    const cikIdx = headers.findIndex(h => h.includes("cik"));
    if (spIdx === -1 || nameIdx === -1 || cikIdx === -1) {
      throw new Error("CSV must have columns for salesperson, account_name, and cik");
    }

    const typeIdx = headers.findIndex(h => h === "type" || h.includes("account_type") || h.includes("firm_type"));
    const contactNameIdx = headers.findIndex(h => h.includes("contact_name") || h === "contact");
    const titleIdx = headers.findIndex(h => h.includes("title") || h.includes("role") || h.includes("position"));
    const emailIdx = headers.findIndex(h => h.includes("email"));
    const phoneIdx = headers.findIndex(h => h.includes("phone"));

    // Find paying_* columns
    const payingCols = headers.map((h, i) => {
      if (h.startsWith("paying_")) return { idx: i, brand: h.replace("paying_", "").replace(/_/g, " ") };
      return null;
    }).filter(Boolean);

    const rows = [];
    for (let r = 1; r < lines.length; r++) {
      const vals = [];
      let current = "", inQuotes = false;
      for (const ch of lines[r]) {
        if (ch === '"') inQuotes = !inQuotes;
        else if (ch === "," && !inQuotes) { vals.push(current.trim()); current = ""; }
        else current += ch;
      }
      vals.push(current.trim());

      const cikRaw = vals[cikIdx]?.replace(/^["']|["']$/g, "") || "";
      if (!cikRaw) continue;

      const paying = {};
      payingCols.forEach(pc => {
        const v = (vals[pc.idx] || "").toLowerCase();
        // Match brand name case-insensitively
        const matchedBrand = AFFILIATE_BRANDS.find(b => b.name.toLowerCase().includes(pc.brand.toLowerCase()) || b.shortName.toLowerCase().includes(pc.brand.toLowerCase()));
        if (matchedBrand) paying[matchedBrand.name] = v === "yes" || v === "true" || v === "1";
      });

      rows.push({
        salesperson: vals[spIdx]?.replace(/^["']|["']$/g, "") || "",
        accountName: vals[nameIdx]?.replace(/^["']|["']$/g, "") || "",
        cik: cikRaw.replace(/^0+/, "").padStart(10, "0"),
        type: typeIdx >= 0 ? vals[typeIdx]?.replace(/^["']|["']$/g, "") || "Hedge Fund" : "Hedge Fund",
        contactName: contactNameIdx >= 0 ? vals[contactNameIdx]?.replace(/^["']|["']$/g, "") || "" : "",
        contactTitle: titleIdx >= 0 ? vals[titleIdx]?.replace(/^["']|["']$/g, "") || "" : "",
        contactEmail: emailIdx >= 0 ? vals[emailIdx]?.replace(/^["']|["']$/g, "") || "" : "",
        contactPhone: phoneIdx >= 0 ? vals[phoneIdx]?.replace(/^["']|["']$/g, "") || "" : "",
        paying,
      });
    }
    return rows;
  };

  const handlePreview = () => {
    try {
      setError("");
      const rows = parseCSV(csvText);
      if (rows.length === 0) throw new Error("No valid data rows found");
      setPreview(rows);
    } catch (e) { setError(e.message); setPreview(null); }
  };

  const handleFileUpload = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => { setCsvText(ev.target.result); };
    reader.readAsText(file);
  };

  const handleImport = () => {
    if (!preview) return;
    // Build data structure from parsed rows
    const spMap = {};
    const acctMap = {};

    preview.forEach(row => {
      // Salespeople
      if (!spMap[row.salesperson]) {
        spMap[row.salesperson] = { id: "sp-" + generateId(), name: row.salesperson };
      }

      // Accounts (keyed by CIK)
      const cikKey = row.cik;
      if (!acctMap[cikKey]) {
        acctMap[cikKey] = {
          cik: cikKey,
          name: row.accountName,
          type: row.type,
          salesperson: spMap[row.salesperson].id,
          contacts: [],
          paying: {},
          campaigns: [],
          cachedHoldings: null,
          lastFetched: null,
        };
      }

      // Merge paying flags
      Object.entries(row.paying).forEach(([brand, val]) => {
        if (val) acctMap[cikKey].paying[brand] = true;
      });

      // Add contact if provided
      if (row.contactName) {
        const existingContact = acctMap[cikKey].contacts.find(c => c.email === row.contactEmail && c.name === row.contactName);
        if (!existingContact) {
          acctMap[cikKey].contacts.push({
            name: row.contactName, title: row.contactTitle,
            email: row.contactEmail, phone: row.contactPhone,
          });
        }
      }
    });

    const newData = {
      salespeople: Object.values(spMap),
      accounts: Object.values(acctMap),
      campaigns: [],
    };
    onImport(newData);
  };

  const inputStyle = {
    width: "100%", padding: "10px 14px", background: "#0a1628", border: "1px solid #1a3040",
    borderRadius: 6, color: "#c8dce8", fontSize: 13, outline: "none", resize: "vertical",
  };

  return (
    <div style={{ background: "#0d1f2d", border: "1px solid #1a3040", borderRadius: 8, padding: 24 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16 }}>
        <div style={{ fontSize: 14, fontWeight: 600, color: "#d0e8dc" }}>Import Account Data (CSV)</div>
        {onClose && <button onClick={onClose} style={{ background: "none", border: "none", color: "#5a7a8a", fontSize: 18, cursor: "pointer" }}>✕</button>}
      </div>

      <div style={{ fontSize: 12, color: "#6a8a9a", marginBottom: 12, lineHeight: 1.6 }}>
        Required columns: <span className="mono" style={{ color: "#7ec8a0" }}>salesperson, account_name, cik</span><br/>
        Optional: <span className="mono" style={{ color: "#5a7a8a" }}>type, contact_name, title, email, phone, paying_cannonball, paying_fermium, ...</span>
      </div>

      <div style={{ display: "flex", gap: 8, marginBottom: 12 }}>
        <input ref={fileRef} type="file" accept=".csv,.txt" onChange={handleFileUpload} style={{ display: "none" }} />
        <button onClick={() => fileRef.current?.click()} style={{
          padding: "8px 16px", background: "#1a3040", border: "1px solid #2a4050", borderRadius: 6,
          color: "#7ec8a0", fontSize: 12, fontWeight: 500,
        }}>Choose File</button>
        <span style={{ fontSize: 11, color: "#4a6a7a", alignSelf: "center" }}>or paste CSV below</span>
      </div>

      <textarea value={csvText} onChange={e => setCsvText(e.target.value)} placeholder="salesperson,account_name,cik,type,contact_name,title,email,phone&#10;Ted Smith,Citadel Advisors LLC,0001423053,Hedge Fund,John Doe,PM,john@citadel.com," rows={6} style={inputStyle} />

      {error && <div style={{ color: "#e57373", fontSize: 12, marginTop: 8 }}>{error}</div>}

      <div style={{ display: "flex", gap: 8, marginTop: 12 }}>
        <button onClick={handlePreview} style={{
          padding: "8px 20px", background: "linear-gradient(135deg, #0a3d62, #1a5276)", border: "1px solid #1a5276",
          borderRadius: 6, color: "#d0e8dc", fontSize: 13, fontWeight: 500,
        }}>Preview</button>
        {preview && (
          <button onClick={handleImport} style={{
            padding: "8px 20px", background: "linear-gradient(135deg, #1e6f5c, #27ae60)", border: "none",
            borderRadius: 6, color: "#fff", fontSize: 13, fontWeight: 600,
          }}>Import {preview.length} Rows</button>
        )}
      </div>

      {preview && (
        <div style={{ marginTop: 16, maxHeight: 200, overflowY: "auto" }}>
          <div style={{ fontSize: 11, color: "#5a7a8a", marginBottom: 8 }}>
            {new Set(preview.map(r => r.salesperson)).size} salespeople · {new Set(preview.map(r => r.cik)).size} unique accounts · {preview.filter(r => r.contactName).length} contacts
          </div>
          <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 11 }}>
            <thead>
              <tr style={{ borderBottom: "1px solid #1a3040" }}>
                {["Salesperson", "Account", "CIK", "Contact"].map(h => (
                  <th key={h} style={{ textAlign: "left", padding: "6px 8px", color: "#5a7a8a", fontWeight: 600 }}>{h}</th>
                ))}
              </tr>
            </thead>
            <tbody>
              {preview.slice(0, 10).map((r, i) => (
                <tr key={i} style={{ borderBottom: "1px solid #0a1628" }}>
                  <td style={{ padding: "5px 8px", color: "#8899aa" }}>{r.salesperson}</td>
                  <td style={{ padding: "5px 8px", color: "#d0e8dc" }}>{r.accountName}</td>
                  <td style={{ padding: "5px 8px", color: "#5a7a8a" }} className="mono">{r.cik}</td>
                  <td style={{ padding: "5px 8px", color: "#8899aa" }}>{r.contactName || "—"}</td>
                </tr>
              ))}
            </tbody>
          </table>
          {preview.length > 10 && <div style={{ fontSize: 10, color: "#4a6a7a", marginTop: 4 }}>...and {preview.length - 10} more rows</div>}
        </div>
      )}
    </div>
  );
}

// ============================================================
// LOGIN PAGE
// ============================================================
function LoginPage({ onLogin }) {
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");
  const [showImport, setShowImport] = useState(false);
  const [importedData, setImportedData] = useState(null);

  const handleLogin = async () => {
    const hash = await hashPassword(password);
    if (hash === PASSWORD_HASH) {
      sessionStorage.setItem("analyst_hub_auth", "true");
      onLogin(importedData);
    } else {
      setError("Invalid password");
    }
  };

  const handleKeyDown = (e) => { if (e.key === "Enter") handleLogin(); };

  const handleImport = (data) => {
    setImportedData(data);
    setShowImport(false);
  };

  return (
    <div style={{ minHeight: "100vh", display: "flex", alignItems: "center", justifyContent: "center", background: "linear-gradient(135deg, #060e1a 0%, #0a1e30 50%, #060e1a 100%)" }}>
      <div style={{ width: 440, animation: "fadeIn 0.4s ease-out" }}>
        <div style={{ textAlign: "center", marginBottom: 32 }}>
          <div style={{ fontSize: 36, fontWeight: 700, background: "linear-gradient(135deg, #7ec8a0, #4fc3f7)", WebkitBackgroundClip: "text", WebkitTextFillColor: "transparent", letterSpacing: -1 }}>
            Analyst Hub
          </div>
          <div style={{ fontSize: 13, color: "#5a7a8a", marginTop: 8 }}>Sales Intelligence Platform</div>
        </div>

        <div style={{ background: "#0d1f2d", border: "1px solid #1a3040", borderRadius: 12, padding: 32 }}>
          <div style={{ marginBottom: 20 }}>
            <label style={{ fontSize: 11, textTransform: "uppercase", letterSpacing: 1, color: "#5a7a8a", marginBottom: 6, display: "block" }}>Password</label>
            <input type="password" value={password} onChange={e => { setPassword(e.target.value); setError(""); }}
              onKeyDown={handleKeyDown} placeholder="Enter team password"
              style={{ width: "100%", padding: "12px 16px", background: "#0a1628", border: `1px solid ${error ? "#e57373" : "#1a3040"}`, borderRadius: 6, color: "#d0e8dc", fontSize: 14, outline: "none" }}
              autoFocus />
            {error && <div style={{ color: "#e57373", fontSize: 12, marginTop: 6 }}>{error}</div>}
          </div>

          <button onClick={handleLogin} style={{
            width: "100%", padding: "12px", background: "linear-gradient(135deg, #1e6f5c, #27ae60)",
            border: "none", borderRadius: 6, color: "#fff", fontSize: 14, fontWeight: 600, marginBottom: 16,
          }}>Sign In</button>

          <div style={{ borderTop: "1px solid #1a3040", paddingTop: 16 }}>
            <button onClick={() => setShowImport(!showImport)} style={{
              width: "100%", padding: "10px", background: "transparent", border: "1px dashed #1a3040",
              borderRadius: 6, color: "#5a7a8a", fontSize: 12, display: "flex", alignItems: "center", justifyContent: "center", gap: 6,
            }}>
              {showImport ? "Hide CSV Import" : "Import Account Data (CSV)"}
              {importedData && <span style={{ color: "#7ec8a0" }}>✓ {importedData.accounts.length} accounts ready</span>}
            </button>
          </div>
        </div>

        {showImport && (
          <div style={{ marginTop: 16, animation: "fadeIn 0.3s ease-out" }}>
            <CSVImporter onImport={handleImport} />
          </div>
        )}
      </div>
    </div>
  );
}

// ============================================================
// SECTOR BREAKDOWN (reused from v3)
// ============================================================
function SectorBreakdown({ holdings }) {
  const sectorData = {};
  let mappedValue = 0;
  const totalValue = holdings.reduce((s, h) => s + h.value, 0);
  holdings.forEach(h => {
    const mapped = CUSIP_SECTOR_MAP[h.cusip];
    if (mapped) {
      const sec = mapped.sector;
      if (!sectorData[sec]) sectorData[sec] = { value: 0, count: 0, holdings: [] };
      sectorData[sec].value += h.value;
      sectorData[sec].count += 1;
      sectorData[sec].holdings.push({ ...h, ...mapped });
      mappedValue += h.value;
    }
  });
  const sorted = Object.entries(sectorData).sort((a, b) => b[1].value - a[1].value);
  const coveragePct = totalValue > 0 ? ((mappedValue / totalValue) * 100).toFixed(1) : 0;

  return (
    <div style={{ background: "#0d1f2d", border: "1px solid #1a3040", borderRadius: 8, padding: 20 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16 }}>
        <div style={{ fontSize: 11, textTransform: "uppercase", letterSpacing: 1.5, color: "#5a7a8a", fontWeight: 600 }}>Sector Allocation</div>
        <div style={{ fontSize: 10, color: "#3a5a6a" }}>{coveragePct}% mapped</div>
      </div>
      <div style={{ display: "flex", height: 20, borderRadius: 4, overflow: "hidden", marginBottom: 16, gap: 1 }}>
        {sorted.map(([sector, data]) => {
          const pct = (data.value / totalValue) * 100;
          if (pct < 0.5) return null;
          return <div key={sector} title={`${sector}: ${pct.toFixed(1)}%`} style={{ width: `${pct}%`, background: SECTOR_COLORS[sector] || SECTOR_COLORS.Unknown, opacity: 0.8 }} />;
        })}
      </div>
      <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(220px, 1fr))", gap: 6 }}>
        {sorted.map(([sector, data]) => {
          const pct = (data.value / totalValue) * 100;
          return (
            <div key={sector} style={{ display: "flex", alignItems: "center", gap: 8, padding: "4px 0" }}>
              <div style={{ width: 10, height: 10, borderRadius: 2, flexShrink: 0, background: SECTOR_COLORS[sector] || SECTOR_COLORS.Unknown }} />
              <span style={{ fontSize: 12, color: "#8899aa", flex: 1 }}>{sector}</span>
              <span className="mono" style={{ fontSize: 12, color: "#d0e8dc", fontWeight: 600 }}>{pct.toFixed(1)}%</span>
              <span className="mono" style={{ fontSize: 11, color: "#4a6a7a" }}>({data.count})</span>
            </div>
          );
        })}
      </div>
      <div style={{ marginTop: 16 }}>
        <div style={{ fontSize: 10, textTransform: "uppercase", letterSpacing: 1, color: "#3a5a6a", marginBottom: 8 }}>Top 3 per sector</div>
        <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(260px, 1fr))", gap: 8 }}>
          {sorted.slice(0, 6).map(([sector, data]) => (
            <div key={sector} style={{ background: "rgba(26,48,64,0.4)", borderRadius: 6, padding: 10, borderLeft: `3px solid ${SECTOR_COLORS[sector] || SECTOR_COLORS.Unknown}` }}>
              <div style={{ fontSize: 11, color: SECTOR_COLORS[sector], fontWeight: 600, marginBottom: 6 }}>{sector}</div>
              {data.holdings.sort((a, b) => b.value - a.value).slice(0, 3).map((h, i) => (
                <div key={i} style={{ display: "flex", justifyContent: "space-between", fontSize: 11, color: "#8899aa", padding: "2px 0" }}>
                  <span>{h.ticker || h.nameOfIssuer?.slice(0, 20)}</span>
                  <span className="mono" style={{ color: "#7ec8a0" }}>{formatValue(h.value * 1000)}</span>
                </div>
              ))}
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

// ============================================================
// COVERAGE OVERLAP (reused from v3)
// ============================================================
function CoverageOverlap({ holdings }) {
  const overlaps = calculateAllOverlaps(holdings);
  const [expanded, setExpanded] = useState(null);
  const relevanceStyles = {
    High: { bg: "rgba(126,200,160,0.12)", border: "rgba(126,200,160,0.4)", badge: "#7ec8a0", badgeBg: "rgba(126,200,160,0.15)" },
    Medium: { bg: "rgba(255,183,77,0.08)", border: "rgba(255,183,77,0.3)", badge: "#ffb74d", badgeBg: "rgba(255,183,77,0.15)" },
    Low: { bg: "rgba(90,122,138,0.08)", border: "rgba(90,122,138,0.2)", badge: "#5a7a8a", badgeBg: "rgba(90,122,138,0.15)" },
    None: { bg: "rgba(26,48,64,0.3)", border: "rgba(26,48,64,0.5)", badge: "#3a5a6a", badgeBg: "rgba(26,48,64,0.3)" },
  };

  return (
    <div style={{ background: "#0d1f2d", border: "1px solid #1a3040", borderRadius: 8, padding: 20 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16 }}>
        <div style={{ fontSize: 11, textTransform: "uppercase", letterSpacing: 1.5, color: "#5a7a8a", fontWeight: 600 }}>Affiliate Coverage Overlap</div>
        <div style={{ fontSize: 10, color: "#3a5a6a" }}>{overlaps.filter(o => o.relevance === "High" || o.relevance === "Medium").length} of {AFFILIATE_BRANDS.length} with meaningful overlap</div>
      </div>
      <div style={{ display: "grid", gap: 8 }}>
        {overlaps.map(o => {
          const s = relevanceStyles[o.relevance];
          const isExp = expanded === o.brand;
          return (
            <div key={o.brand} onClick={() => setExpanded(isExp ? null : o.brand)} style={{ background: s.bg, border: `1px solid ${s.border}`, borderRadius: 6, overflow: "hidden", cursor: "pointer" }}>
              <div style={{ padding: "12px 16px", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
                  <div style={{ width: 4, height: 28, borderRadius: 2, background: o.color }} />
                  <div>
                    <div style={{ fontSize: 13, fontWeight: 600, color: "#d0e8dc" }}>{o.brand}</div>
                    <div style={{ fontSize: 11, color: "#6a8a9a" }}>{o.focus}</div>
                  </div>
                </div>
                <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
                  {!o.universal && o.matchedCount > 0 && <span style={{ fontSize: 11, color: "#5a7a8a" }}>{o.matchedCount} pos · {formatValue(o.matchedValue)}</span>}
                  <span style={{ padding: "3px 10px", borderRadius: 4, fontSize: 10, fontWeight: 600, textTransform: "uppercase", background: s.badgeBg, color: s.badge }}>{o.relevance}</span>
                  <span style={{ fontSize: 10, color: "#4a6a7a", transform: isExp ? "rotate(180deg)" : "none", transition: "transform 0.15s" }}>▼</span>
                </div>
              </div>
              {isExp && (
                <div style={{ padding: "0 16px 12px 30px" }}>
                  <div style={{ fontSize: 12, color: "#8899aa", marginBottom: 8, fontStyle: "italic" }}>{o.reason}</div>
                  {o.matchedHoldings.length > 0 && o.matchedHoldings.map((h, i) => (
                    <div key={i} style={{ display: "flex", justifyContent: "space-between", fontSize: 11, padding: "3px 0", color: "#8899aa" }}>
                      <span><span style={{ color: "#d0e8dc", fontWeight: 500 }}>{h.ticker || h.nameOfIssuer?.slice(0, 20)}</span> <span style={{ fontSize: 9, color: "#4a6a7a" }}>{h.matchType}</span></span>
                      <span className="mono" style={{ color: "#7ec8a0" }}>{formatValue(h.value * 1000)}</span>
                    </div>
                  ))}
                </div>
              )}
            </div>
          );
        })}
      </div>
    </div>
  );
}

// ============================================================
// HOLDINGS TABLE
// ============================================================
function HoldingsTable({ holdings, filingInfo, searchTerm: initSearch }) {
  const [sortKey, setSortKey] = useState("value");
  const [sortDir, setSortDir] = useState("desc");
  const [search, setSearch] = useState(initSearch || "");

  const sorted = useMemo(() => {
    let filtered = holdings;
    if (search) {
      const q = search.toLowerCase();
      filtered = holdings.filter(h => h.nameOfIssuer?.toLowerCase().includes(q) || h.cusip?.includes(q) || CUSIP_SECTOR_MAP[h.cusip]?.ticker?.toLowerCase().includes(q));
    }
    return [...filtered].sort((a, b) => {
      let av, bv;
      if (sortKey === "value") { av = a.value; bv = b.value; }
      else if (sortKey === "shares") { av = a.shrsOrPrnAmt?.sshPrnamt || 0; bv = b.shrsOrPrnAmt?.sshPrnamt || 0; }
      else if (sortKey === "name") { av = a.nameOfIssuer; bv = b.nameOfIssuer; return sortDir === "asc" ? av.localeCompare(bv) : bv.localeCompare(av); }
      else { av = a.value; bv = b.value; }
      return sortDir === "asc" ? av - bv : bv - av;
    });
  }, [holdings, sortKey, sortDir, search]);

  const toggleSort = (key) => {
    if (sortKey === key) setSortDir(d => d === "asc" ? "desc" : "asc");
    else { setSortKey(key); setSortDir("desc"); }
  };

  const thStyle = { textAlign: "left", padding: "8px 10px", fontSize: 10, textTransform: "uppercase", letterSpacing: 1, color: "#5a7a8a", fontWeight: 600, cursor: "pointer", userSelect: "none", borderBottom: "1px solid #1a3040" };

  return (
    <div style={{ background: "#0d1f2d", border: "1px solid #1a3040", borderRadius: 8, padding: 20 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
        <div style={{ fontSize: 11, textTransform: "uppercase", letterSpacing: 1.5, color: "#5a7a8a", fontWeight: 600 }}>
          13F Holdings {filingInfo && <span style={{ color: "#3a5a6a" }}>· {filingInfo.reportDate} · {filingInfo.source === "sample" ? "Sample Data" : "SEC EDGAR"}</span>}
        </div>
        <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
          <span className="mono" style={{ fontSize: 11, color: "#7ec8a0" }}>{holdings.length.toLocaleString()} positions</span>
          <input value={search} onChange={e => setSearch(e.target.value)} placeholder="Filter..." style={{ padding: "5px 10px", background: "#0a1628", border: "1px solid #1a3040", borderRadius: 4, color: "#c8dce8", fontSize: 11, width: 140, outline: "none" }} />
        </div>
      </div>
      <div style={{ maxHeight: 500, overflowY: "auto" }}>
        <table style={{ width: "100%", borderCollapse: "collapse" }}>
          <thead>
            <tr>
              <th style={thStyle}>#</th>
              <th style={thStyle} onClick={() => toggleSort("name")}>Issuer {sortKey === "name" ? (sortDir === "asc" ? "↑" : "↓") : ""}</th>
              <th style={thStyle}>Ticker</th>
              <th style={thStyle}>Sector</th>
              <th style={{ ...thStyle, textAlign: "right" }} onClick={() => toggleSort("value")}>Value {sortKey === "value" ? (sortDir === "asc" ? "↑" : "↓") : ""}</th>
              <th style={{ ...thStyle, textAlign: "right" }} onClick={() => toggleSort("shares")}>Shares {sortKey === "shares" ? (sortDir === "asc" ? "↑" : "↓") : ""}</th>
            </tr>
          </thead>
          <tbody>
            {sorted.slice(0, 200).map((h, i) => {
              const mapped = CUSIP_SECTOR_MAP[h.cusip];
              return (
                <tr key={i} style={{ borderBottom: "1px solid #0a1628" }} onMouseEnter={e => e.currentTarget.style.background = "rgba(126,200,160,0.04)"} onMouseLeave={e => e.currentTarget.style.background = "transparent"}>
                  <td style={{ padding: "6px 10px", fontSize: 11, color: "#3a5a6a" }}>{i + 1}</td>
                  <td style={{ padding: "6px 10px", fontSize: 12, color: "#d0e8dc" }}>{h.nameOfIssuer}</td>
                  <td className="mono" style={{ padding: "6px 10px", fontSize: 11, color: mapped ? "#7ec8a0" : "#4a6a7a" }}>{mapped?.ticker || "—"}</td>
                  <td style={{ padding: "6px 10px", fontSize: 11, color: SECTOR_COLORS[mapped?.sector] || "#4a6a7a" }}>{mapped?.sector || "—"}</td>
                  <td className="mono" style={{ padding: "6px 10px", fontSize: 12, color: "#7ec8a0", textAlign: "right" }}>{formatValue(h.value * 1000)}</td>
                  <td className="mono" style={{ padding: "6px 10px", fontSize: 11, color: "#8899aa", textAlign: "right" }}>{formatShares(h.shrsOrPrnAmt?.sshPrnamt)}</td>
                </tr>
              );
            })}
          </tbody>
        </table>
        {sorted.length > 200 && <div style={{ textAlign: "center", padding: 12, fontSize: 11, color: "#4a6a7a" }}>Showing top 200 of {sorted.length}</div>}
      </div>
    </div>
  );
}

// ============================================================
// CONTACT EDITOR
// ============================================================
function ContactEditor({ contacts, onChange }) {
  const [editing, setEditing] = useState(null);
  const [draft, setDraft] = useState({ name: "", title: "", email: "", phone: "" });

  const startAdd = () => { setDraft({ name: "", title: "", email: "", phone: "" }); setEditing("new"); };
  const startEdit = (i) => { setDraft({ ...contacts[i] }); setEditing(i); };
  const save = () => {
    if (!draft.name.trim()) return;
    const updated = [...contacts];
    if (editing === "new") updated.push({ ...draft });
    else updated[editing] = { ...draft };
    onChange(updated);
    setEditing(null);
  };
  const remove = (i) => { onChange(contacts.filter((_, idx) => idx !== i)); };

  const inputStyle = { padding: "6px 10px", background: "#0a1628", border: "1px solid #1a3040", borderRadius: 4, color: "#c8dce8", fontSize: 12, outline: "none", width: "100%" };

  return (
    <div style={{ background: "#0d1f2d", border: "1px solid #1a3040", borderRadius: 8, padding: 20 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
        <div style={{ fontSize: 11, textTransform: "uppercase", letterSpacing: 1.5, color: "#5a7a8a", fontWeight: 600 }}>Contacts ({contacts.length})</div>
        <button onClick={startAdd} style={{ padding: "4px 12px", background: "#1a3040", border: "1px solid #2a4050", borderRadius: 4, color: "#7ec8a0", fontSize: 11 }}>+ Add</button>
      </div>

      {contacts.map((c, i) => (
        <div key={i} style={{ display: "flex", alignItems: "center", gap: 12, padding: "8px 0", borderBottom: "1px solid #0a1628" }}>
          <div style={{ flex: 1 }}>
            <div style={{ fontSize: 13, color: "#d0e8dc", fontWeight: 500 }}>{c.name}</div>
            <div style={{ fontSize: 11, color: "#6a8a9a" }}>{c.title}{c.title && c.email ? " · " : ""}{c.email}</div>
            {c.phone && <div style={{ fontSize: 11, color: "#5a7a8a" }}>{c.phone}</div>}
          </div>
          <button onClick={() => startEdit(i)} style={{ background: "none", border: "none", color: "#5a7a8a", fontSize: 11, cursor: "pointer" }}>Edit</button>
          <button onClick={() => remove(i)} style={{ background: "none", border: "none", color: "#e57373", fontSize: 11, cursor: "pointer" }}>✕</button>
        </div>
      ))}

      {editing !== null && (
        <div style={{ marginTop: 12, padding: 12, background: "#0a1628", borderRadius: 6, display: "grid", gridTemplateColumns: "1fr 1fr", gap: 8 }}>
          <input value={draft.name} onChange={e => setDraft({ ...draft, name: e.target.value })} placeholder="Name *" style={inputStyle} autoFocus />
          <input value={draft.title} onChange={e => setDraft({ ...draft, title: e.target.value })} placeholder="Title" style={inputStyle} />
          <input value={draft.email} onChange={e => setDraft({ ...draft, email: e.target.value })} placeholder="Email" style={inputStyle} />
          <input value={draft.phone} onChange={e => setDraft({ ...draft, phone: e.target.value })} placeholder="Phone" style={inputStyle} />
          <div style={{ gridColumn: "1 / -1", display: "flex", gap: 8, justifyContent: "flex-end" }}>
            <button onClick={() => setEditing(null)} style={{ padding: "6px 14px", background: "none", border: "1px solid #1a3040", borderRadius: 4, color: "#5a7a8a", fontSize: 12 }}>Cancel</button>
            <button onClick={save} style={{ padding: "6px 14px", background: "#1e6f5c", border: "none", borderRadius: 4, color: "#fff", fontSize: 12, fontWeight: 500 }}>Save</button>
          </div>
        </div>
      )}
      {contacts.length === 0 && editing === null && <div style={{ fontSize: 12, color: "#3a5a6a", padding: "12px 0", textAlign: "center" }}>No contacts yet</div>}
    </div>
  );
}

// ============================================================
// CAMPAIGN MANAGER
// ============================================================
function CampaignManager({ data, setData, currentAccount }) {
  const [showCreate, setShowCreate] = useState(false);
  const [newName, setNewName] = useState("");
  const [newAffiliate, setNewAffiliate] = useState(AFFILIATE_BRANDS[0]?.name || "");

  const createCampaign = () => {
    if (!newName.trim()) return;
    const campaign = { id: "camp-" + generateId(), affiliate: newAffiliate, name: newName.trim(), accounts: currentAccount ? [currentAccount] : [] };
    const updated = { ...data, campaigns: [...data.campaigns, campaign] };
    setData(updated);
    saveData(updated);
    setNewName("");
    setShowCreate(false);
  };

  const addToCampaign = (campId) => {
    if (!currentAccount) return;
    const updated = {
      ...data,
      campaigns: data.campaigns.map(c => c.id === campId && !c.accounts.includes(currentAccount) ? { ...c, accounts: [...c.accounts, currentAccount] } : c),
      accounts: data.accounts.map(a => a.cik === currentAccount && !a.campaigns.includes(campId) ? { ...a, campaigns: [...a.campaigns, campId] } : a),
    };
    setData(updated);
    saveData(updated);
  };

  const removeFromCampaign = (campId) => {
    if (!currentAccount) return;
    const updated = {
      ...data,
      campaigns: data.campaigns.map(c => c.id === campId ? { ...c, accounts: c.accounts.filter(a => a !== currentAccount) } : c),
      accounts: data.accounts.map(a => a.cik === currentAccount ? { ...a, campaigns: a.campaigns.filter(c => c !== campId) } : a),
    };
    setData(updated);
    saveData(updated);
  };

  const exportCampaign = (campaign) => {
    const accts = data.accounts.filter(a => campaign.accounts.includes(a.cik));
    let csv = "account_name,cik,contact_name,contact_title,contact_email,contact_phone\n";
    accts.forEach(a => {
      if (a.contacts.length === 0) {
        csv += `"${a.name}",${a.cik},,,,\n`;
      } else {
        a.contacts.forEach(c => {
          csv += `"${a.name}",${a.cik},"${c.name}","${c.title}","${c.email}","${c.phone}"\n`;
        });
      }
    });
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${campaign.name.replace(/\s+/g, "_")}_contacts.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };

  const deleteCampaign = (campId) => {
    const updated = {
      ...data,
      campaigns: data.campaigns.filter(c => c.id !== campId),
      accounts: data.accounts.map(a => ({ ...a, campaigns: a.campaigns.filter(c => c !== campId) })),
    };
    setData(updated);
    saveData(updated);
  };

  return (
    <div style={{ background: "#0d1f2d", border: "1px solid #1a3040", borderRadius: 8, padding: 20 }}>
      <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
        <div style={{ fontSize: 11, textTransform: "uppercase", letterSpacing: 1.5, color: "#5a7a8a", fontWeight: 600 }}>Campaigns</div>
        <button onClick={() => setShowCreate(!showCreate)} style={{ padding: "4px 12px", background: "#1a3040", border: "1px solid #2a4050", borderRadius: 4, color: "#7ec8a0", fontSize: 11 }}>+ New</button>
      </div>

      {showCreate && (
        <div style={{ padding: 12, background: "#0a1628", borderRadius: 6, marginBottom: 12, display: "flex", gap: 8, alignItems: "flex-end" }}>
          <div style={{ flex: 1 }}>
            <label style={{ fontSize: 10, color: "#5a7a8a", display: "block", marginBottom: 4 }}>Campaign Name</label>
            <input value={newName} onChange={e => setNewName(e.target.value)} placeholder="Q1 Outreach" style={{ width: "100%", padding: "6px 10px", background: "#060e1a", border: "1px solid #1a3040", borderRadius: 4, color: "#c8dce8", fontSize: 12, outline: "none" }} />
          </div>
          <div style={{ flex: 1 }}>
            <label style={{ fontSize: 10, color: "#5a7a8a", display: "block", marginBottom: 4 }}>Affiliate</label>
            <select value={newAffiliate} onChange={e => setNewAffiliate(e.target.value)} style={{ width: "100%", padding: "6px 10px", background: "#060e1a", border: "1px solid #1a3040", borderRadius: 4, color: "#c8dce8", fontSize: 12, outline: "none" }}>
              {AFFILIATE_BRANDS.map(b => <option key={b.name} value={b.name}>{b.name}</option>)}
            </select>
          </div>
          <button onClick={createCampaign} style={{ padding: "6px 14px", background: "#1e6f5c", border: "none", borderRadius: 4, color: "#fff", fontSize: 12, fontWeight: 500, whiteSpace: "nowrap" }}>Create</button>
        </div>
      )}

      {data.campaigns.length === 0 && !showCreate && <div style={{ fontSize: 12, color: "#3a5a6a", padding: "12px 0", textAlign: "center" }}>No campaigns yet</div>}

      {data.campaigns.map(c => {
        const isInCampaign = currentAccount && c.accounts.includes(currentAccount);
        return (
          <div key={c.id} style={{ display: "flex", alignItems: "center", gap: 10, padding: "8px 0", borderBottom: "1px solid #0a1628" }}>
            <div style={{ flex: 1 }}>
              <div style={{ fontSize: 12, color: "#d0e8dc", fontWeight: 500 }}>{c.name}</div>
              <div style={{ fontSize: 11, color: "#5a7a8a" }}>{c.affiliate} · {c.accounts.length} account{c.accounts.length !== 1 ? "s" : ""}</div>
            </div>
            {currentAccount && (
              isInCampaign
                ? <button onClick={() => removeFromCampaign(c.id)} style={{ padding: "4px 10px", background: "rgba(126,200,160,0.15)", border: "1px solid rgba(126,200,160,0.3)", borderRadius: 4, color: "#7ec8a0", fontSize: 10 }}>✓ Added</button>
                : <button onClick={() => addToCampaign(c.id)} style={{ padding: "4px 10px", background: "#1a3040", border: "1px solid #2a4050", borderRadius: 4, color: "#8899aa", fontSize: 10 }}>+ Add</button>
            )}
            <button onClick={() => exportCampaign(c)} title="Export CSV" style={{ background: "none", border: "none", color: "#5a7a8a", fontSize: 13, cursor: "pointer" }}>↓</button>
            <button onClick={() => deleteCampaign(c.id)} style={{ background: "none", border: "none", color: "#e57373", fontSize: 11, cursor: "pointer" }}>✕</button>
          </div>
        );
      })}
    </div>
  );
}

// ============================================================
// AFFILIATE GRID — 11 brand cards with overlap metrics per salesperson
// ============================================================
function AffiliateGrid({ accounts, onSelectAffiliate }) {
  // For each brand, compute metrics across all accounts
  const brandMetrics = useMemo(() => {
    return AFFILIATE_BRANDS.map(brand => {
      let highCount = 0, medCount = 0, payingCount = 0, totalScore = 0, scoredCount = 0;

      accounts.forEach(acct => {
        // Use cached holdings or generate sample
        const holdings = acct.cachedHoldings || generateSampleHoldings({ name: acct.name, cik: acct.cik, type: acct.type || "Hedge Fund" }).holdings;
        const overlap = calculateBrandOverlap(holdings, brand);
        totalScore += overlap.score;
        scoredCount++;
        if (overlap.relevance === "High") highCount++;
        else if (overlap.relevance === "Medium") medCount++;
        if (acct.paying?.[brand.name]) payingCount++;
      });

      return {
        ...brand,
        highCount, medCount, payingCount,
        avgScore: scoredCount > 0 ? totalScore / scoredCount : 0,
        totalAccounts: accounts.length,
      };
    });
  }, [accounts]);

  return (
    <div>
      <div style={{ fontSize: 11, textTransform: "uppercase", letterSpacing: 1.5, color: "#5a7a8a", fontWeight: 600, marginBottom: 16 }}>
        Affiliate Brands ({AFFILIATE_BRANDS.length})
      </div>
      <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(280px, 1fr))", gap: 12 }}>
        {brandMetrics.map(bm => (
          <div key={bm.name} onClick={() => onSelectAffiliate(bm.name)}
            style={{
              background: "#0d1f2d", border: "1px solid #1a3040", borderRadius: 8, padding: 20,
              cursor: "pointer", transition: "all 0.2s", borderLeft: `4px solid ${bm.color}`,
            }}
            onMouseEnter={e => { e.currentTarget.style.borderColor = bm.color; e.currentTarget.style.transform = "translateY(-2px)"; }}
            onMouseLeave={e => { e.currentTarget.style.borderColor = "#1a3040"; e.currentTarget.style.borderLeftColor = bm.color; e.currentTarget.style.transform = "none"; }}
          >
            <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 12 }}>
              <div>
                <div style={{ fontSize: 15, fontWeight: 600, color: "#d0e8dc" }}>{bm.name}</div>
                <div style={{ fontSize: 11, color: "#6a8a9a", marginTop: 2 }}>{bm.focus}</div>
              </div>
              {bm.universal && <span style={{ padding: "2px 8px", borderRadius: 4, fontSize: 9, background: "rgba(255,241,118,0.15)", color: "#fff176", fontWeight: 600 }}>MACRO</span>}
            </div>

            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 8 }}>
              <div style={{ textAlign: "center", padding: 8, background: "rgba(126,200,160,0.08)", borderRadius: 6 }}>
                <div className="mono" style={{ fontSize: 20, fontWeight: 700, color: "#7ec8a0" }}>{bm.highCount}</div>
                <div style={{ fontSize: 9, textTransform: "uppercase", letterSpacing: 0.5, color: "#5a7a8a", marginTop: 2 }}>High</div>
              </div>
              <div style={{ textAlign: "center", padding: 8, background: "rgba(255,183,77,0.08)", borderRadius: 6 }}>
                <div className="mono" style={{ fontSize: 20, fontWeight: 700, color: "#ffb74d" }}>{bm.medCount}</div>
                <div style={{ fontSize: 9, textTransform: "uppercase", letterSpacing: 0.5, color: "#5a7a8a", marginTop: 2 }}>Medium</div>
              </div>
              <div style={{ textAlign: "center", padding: 8, background: "rgba(79,195,247,0.08)", borderRadius: 6 }}>
                <div className="mono" style={{ fontSize: 20, fontWeight: 700, color: "#4fc3f7" }}>{bm.payingCount}</div>
                <div style={{ fontSize: 9, textTransform: "uppercase", letterSpacing: 0.5, color: "#5a7a8a", marginTop: 2 }}>Paying</div>
              </div>
            </div>

            <div style={{ marginTop: 10, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
              <div style={{ fontSize: 11, color: "#4a6a7a" }}>Avg overlap</div>
              <div className="mono" style={{ fontSize: 12, color: bm.avgScore > 12 ? "#7ec8a0" : bm.avgScore > 4 ? "#ffb74d" : "#5a7a8a" }}>{bm.avgScore.toFixed(1)}%</div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

// ============================================================
// AFFILIATE DETAIL — ranked accounts for one brand
// ============================================================
function AffiliateDetail({ brandName, accounts, onSelectAccount, onBack }) {
  const brand = AFFILIATE_BRANDS.find(b => b.name === brandName);
  const [loading, setLoading] = useState(false);

  const accountScores = useMemo(() => {
    return accounts.map(acct => {
      const holdings = acct.cachedHoldings || generateSampleHoldings({ name: acct.name, cik: acct.cik, type: acct.type || "Hedge Fund" }).holdings;
      const overlap = calculateBrandOverlap(holdings, brand);
      return { ...acct, overlap, holdings };
    }).sort((a, b) => b.overlap.score - a.overlap.score);
  }, [accounts, brand]);

  const relevBadge = (rel) => {
    const colors = { High: "#7ec8a0", Medium: "#ffb74d", Low: "#5a7a8a", None: "#3a5a6a" };
    return <span style={{ padding: "2px 8px", borderRadius: 4, fontSize: 9, fontWeight: 600, textTransform: "uppercase", background: `${colors[rel]}20`, color: colors[rel] }}>{rel}</span>;
  };

  return (
    <div>
      <button onClick={onBack} style={{ background: "none", border: "none", color: "#5a7a8a", fontSize: 12, marginBottom: 16, cursor: "pointer", display: "flex", alignItems: "center", gap: 4 }}>
        ← Back to Affiliates
      </button>
      <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 20 }}>
        <div style={{ width: 6, height: 32, borderRadius: 3, background: brand?.color || "#5a7a8a" }} />
        <div>
          <div style={{ fontSize: 20, fontWeight: 700, color: "#d0e8dc" }}>{brandName}</div>
          <div style={{ fontSize: 13, color: "#6a8a9a" }}>{brand?.focus}</div>
        </div>
      </div>

      <div style={{ fontSize: 11, color: "#5a7a8a", marginBottom: 12 }}>
        {accountScores.filter(a => a.overlap.relevance === "High" || a.overlap.relevance === "Medium").length} of {accountScores.length} accounts with meaningful overlap
      </div>

      <div style={{ display: "grid", gap: 8 }}>
        {accountScores.map(acct => (
          <div key={acct.cik} onClick={() => onSelectAccount(acct.cik)}
            style={{
              background: "#0d1f2d", border: "1px solid #1a3040", borderRadius: 8, padding: "14px 20px",
              cursor: "pointer", transition: "all 0.15s", display: "flex", justifyContent: "space-between", alignItems: "center",
            }}
            onMouseEnter={e => e.currentTarget.style.borderColor = brand?.color || "#1a3040"}
            onMouseLeave={e => e.currentTarget.style.borderColor = "#1a3040"}
          >
            <div style={{ flex: 1 }}>
              <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                <span style={{ fontSize: 14, fontWeight: 600, color: "#d0e8dc" }}>{acct.name}</span>
                {acct.paying?.[brandName] && <span style={{ padding: "1px 6px", borderRadius: 3, fontSize: 9, background: "rgba(79,195,247,0.15)", color: "#4fc3f7", fontWeight: 600 }}>PAYING</span>}
              </div>
              <div style={{ fontSize: 11, color: "#5a7a8a", marginTop: 2 }}>
                {acct.type} · {acct.contacts?.length || 0} contact{acct.contacts?.length !== 1 ? "s" : ""} · CIK {acct.cik}
              </div>
            </div>
            <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
              <div style={{ textAlign: "right" }}>
                <div className="mono" style={{ fontSize: 16, fontWeight: 700, color: acct.overlap.score > 12 ? "#7ec8a0" : acct.overlap.score > 4 ? "#ffb74d" : "#5a7a8a" }}>
                  {acct.overlap.universal ? "✦" : `${acct.overlap.score.toFixed(1)}%`}
                </div>
              </div>
              {relevBadge(acct.overlap.relevance)}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

// ============================================================
// ACCOUNT DETAIL — holdings, overlap, contacts, campaigns
// ============================================================
function AccountDetail({ accountCik, data, setData, onBack }) {
  const [holdings, setHoldings] = useState([]);
  const [filingInfo, setFilingInfo] = useState(null);
  const [loading, setLoading] = useState(true);
  const [activeTab, setActiveTab] = useState("holdings");

  const account = data.accounts.find(a => a.cik === accountCik);

  useEffect(() => {
    if (!account) return;
    let cancelled = false;
    setLoading(true);

    (async () => {
      if (account.cachedHoldings && account.lastFetched) {
        setHoldings(account.cachedHoldings);
        setFilingInfo(account.cachedFilingInfo || null);
        setLoading(false);
        return;
      }
      try {
        const result = await fetchAccountHoldings(account);
        if (cancelled) return;
        setHoldings(result.holdings);
        setFilingInfo(result.filingInfo);
        // Cache holdings
        const updated = {
          ...data,
          accounts: data.accounts.map(a => a.cik === accountCik ? { ...a, cachedHoldings: result.holdings, cachedFilingInfo: result.filingInfo, lastFetched: new Date().toISOString() } : a),
        };
        setData(updated);
        saveData(updated);
      } catch (e) {
        console.error("Fetch failed:", e);
        const sample = generateSampleHoldings({ name: account.name, cik: account.cik, type: account.type });
        setHoldings(sample.holdings);
        setFilingInfo(sample.filingInfo);
      }
      if (!cancelled) setLoading(false);
    })();

    return () => { cancelled = true; };
  }, [accountCik]);

  const updateAccount = (changes) => {
    const updated = {
      ...data,
      accounts: data.accounts.map(a => a.cik === accountCik ? { ...a, ...changes } : a),
    };
    setData(updated);
    saveData(updated);
  };

  const togglePaying = (brandName) => {
    const newPaying = { ...(account.paying || {}) };
    newPaying[brandName] = !newPaying[brandName];
    updateAccount({ paying: newPaying });
  };

  const handleContactsChange = (contacts) => { updateAccount({ contacts }); };

  const refreshHoldings = async () => {
    setLoading(true);
    try {
      const result = await fetchAccountHoldings(account);
      setHoldings(result.holdings);
      setFilingInfo(result.filingInfo);
      updateAccount({ cachedHoldings: result.holdings, cachedFilingInfo: result.filingInfo, lastFetched: new Date().toISOString() });
    } catch (e) {
      console.error("Refresh failed:", e);
    }
    setLoading(false);
  };

  if (!account) return <div style={{ color: "#e57373", padding: 40 }}>Account not found</div>;

  const tabs = [
    { id: "holdings", label: "13F Holdings" },
    { id: "overlap", label: "Coverage Overlap" },
    { id: "contacts", label: `Contacts (${account.contacts?.length || 0})` },
    { id: "campaigns", label: "Campaigns" },
  ];

  return (
    <div>
      <button onClick={onBack} style={{ background: "none", border: "none", color: "#5a7a8a", fontSize: 12, marginBottom: 16, cursor: "pointer" }}>
        ← Back
      </button>

      <div style={{ marginBottom: 20 }}>
        <div style={{ fontSize: 22, fontWeight: 700, color: "#d0e8dc" }}>{account.name}</div>
        <div style={{ fontSize: 13, color: "#6a8a9a", marginTop: 4 }}>
          {account.type} · CIK {account.cik}
          {account.lastFetched && <span style={{ marginLeft: 8, fontSize: 11, color: "#3a5a6a" }}>Last fetched: {new Date(account.lastFetched).toLocaleDateString()}</span>}
          <button onClick={refreshHoldings} style={{ marginLeft: 8, background: "none", border: "none", color: "#4fc3f7", fontSize: 11, cursor: "pointer" }}>↻ Refresh</button>
        </div>
      </div>

      {/* Open for Business toggles */}
      <div style={{ background: "#0d1f2d", border: "1px solid #1a3040", borderRadius: 8, padding: 16, marginBottom: 16 }}>
        <div style={{ fontSize: 11, textTransform: "uppercase", letterSpacing: 1.5, color: "#5a7a8a", fontWeight: 600, marginBottom: 10 }}>Open for Business</div>
        <div style={{ display: "flex", flexWrap: "wrap", gap: 6 }}>
          {AFFILIATE_BRANDS.map(b => {
            const isPaying = account.paying?.[b.name];
            return (
              <button key={b.name} onClick={() => togglePaying(b.name)}
                style={{
                  padding: "4px 12px", borderRadius: 20, fontSize: 11, fontWeight: 500, border: "1px solid",
                  cursor: "pointer", transition: "all 0.15s",
                  background: isPaying ? `${b.color}20` : "transparent",
                  borderColor: isPaying ? b.color : "#1a3040",
                  color: isPaying ? b.color : "#4a6a7a",
                }}>
                {isPaying ? "✓ " : ""}{b.shortName}
              </button>
            );
          })}
        </div>
      </div>

      {/* Tabs */}
      <div style={{ display: "flex", gap: 0, marginBottom: 16, borderBottom: "1px solid #1a3040" }}>
        {tabs.map(t => (
          <button key={t.id} onClick={() => setActiveTab(t.id)}
            style={{
              padding: "10px 20px", background: "none", border: "none", borderBottom: `2px solid ${activeTab === t.id ? "#7ec8a0" : "transparent"}`,
              color: activeTab === t.id ? "#d0e8dc" : "#5a7a8a", fontSize: 13, fontWeight: activeTab === t.id ? 600 : 400, cursor: "pointer",
            }}>
            {t.label}
          </button>
        ))}
      </div>

      {loading && (
        <div style={{ display: "flex", alignItems: "center", gap: 8, padding: 40, justifyContent: "center" }}>
          <div style={{ width: 16, height: 16, border: "2px solid #1a3040", borderTopColor: "#7ec8a0", borderRadius: "50%", animation: "spin 0.8s linear infinite" }} />
          <span style={{ color: "#5a7a8a", fontSize: 13 }}>Loading 13F data from SEC EDGAR...</span>
        </div>
      )}

      {!loading && activeTab === "holdings" && (
        <div style={{ display: "grid", gap: 16 }}>
          <HoldingsTable holdings={holdings} filingInfo={filingInfo} />
          <SectorBreakdown holdings={holdings} />
        </div>
      )}

      {!loading && activeTab === "overlap" && <CoverageOverlap holdings={holdings} />}

      {activeTab === "contacts" && (
        <ContactEditor contacts={account.contacts || []} onChange={handleContactsChange} />
      )}

      {activeTab === "campaigns" && (
        <CampaignManager data={data} setData={setData} currentAccount={accountCik} />
      )}
    </div>
  );
}

// ============================================================
// DASHBOARD — navbar + salesperson tabs + content
// ============================================================
function Dashboard({ data, setData, onLogout }) {
  const [currentSP, setCurrentSP] = useState(data.salespeople[0]?.id || null);
  const [view, setView] = useState("grid"); // grid | affiliate | account
  const [selectedAffiliate, setSelectedAffiliate] = useState(null);
  const [selectedAccount, setSelectedAccount] = useState(null);
  const [showImport, setShowImport] = useState(false);
  const [showAllCampaigns, setShowAllCampaigns] = useState(false);

  const spAccounts = useMemo(() => {
    if (!currentSP) return [];
    return data.accounts.filter(a => a.salesperson === currentSP);
  }, [data.accounts, currentSP]);

  const handleSelectAffiliate = (brandName) => {
    setSelectedAffiliate(brandName);
    setView("affiliate");
  };

  const handleSelectAccount = (cik) => {
    setSelectedAccount(cik);
    setView("account");
  };

  const handleBackToGrid = () => { setView("grid"); setSelectedAffiliate(null); };
  const handleBackToAffiliate = () => { setView("affiliate"); setSelectedAccount(null); };

  const handleImport = (newData) => {
    // Merge with existing
    const merged = { ...data };
    // Add new salespeople (dedup by name)
    newData.salespeople.forEach(sp => {
      if (!merged.salespeople.find(s => s.name === sp.name)) {
        merged.salespeople.push(sp);
      }
    });
    // Add/update accounts (dedup by CIK)
    newData.accounts.forEach(acct => {
      const spName = newData.salespeople.find(s => s.id === acct.salesperson)?.name;
      const mergedSP = merged.salespeople.find(s => s.name === spName);
      const existing = merged.accounts.find(a => a.cik === acct.cik);
      if (existing) {
        // Merge contacts and paying flags
        acct.contacts.forEach(c => {
          if (!existing.contacts.find(ec => ec.name === c.name && ec.email === c.email)) {
            existing.contacts.push(c);
          }
        });
        Object.assign(existing.paying, acct.paying);
        if (mergedSP) existing.salesperson = mergedSP.id;
      } else {
        merged.accounts.push({ ...acct, salesperson: mergedSP?.id || acct.salesperson });
      }
    });
    setData(merged);
    saveData(merged);
    setShowImport(false);
    if (!currentSP && merged.salespeople.length > 0) setCurrentSP(merged.salespeople[0].id);
  };

  const currentSPName = data.salespeople.find(s => s.id === currentSP)?.name || "";

  return (
    <div style={{ minHeight: "100vh", background: "#060e1a" }}>
      {/* Navbar */}
      <div style={{ background: "#0a1628", borderBottom: "1px solid #1a3040", padding: "0 24px", display: "flex", alignItems: "center", justifyContent: "space-between", height: 56 }}>
        <div style={{ display: "flex", alignItems: "center", gap: 16 }}>
          <div style={{ fontSize: 18, fontWeight: 700, background: "linear-gradient(135deg, #7ec8a0, #4fc3f7)", WebkitBackgroundClip: "text", WebkitTextFillColor: "transparent" }}>Analyst Hub</div>
        </div>
        <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
          <span style={{ fontSize: 11, color: "#5a7a8a" }}>{data.accounts.length} accounts · {data.salespeople.length} reps</span>
          <button onClick={() => setShowImport(!showImport)} style={{ padding: "5px 12px", background: "#1a3040", border: "1px solid #2a4050", borderRadius: 4, color: "#7ec8a0", fontSize: 11 }}>Import CSV</button>
          <button onClick={() => setShowAllCampaigns(!showAllCampaigns)} style={{ padding: "5px 12px", background: "#1a3040", border: "1px solid #2a4050", borderRadius: 4, color: "#4fc3f7", fontSize: 11 }}>Campaigns</button>
          <button onClick={onLogout} style={{ padding: "5px 12px", background: "none", border: "1px solid #1a3040", borderRadius: 4, color: "#5a7a8a", fontSize: 11 }}>Sign Out</button>
        </div>
      </div>

      {/* Import overlay */}
      {showImport && (
        <div style={{ padding: "16px 24px", borderBottom: "1px solid #1a3040", animation: "fadeIn 0.2s" }}>
          <CSVImporter onImport={handleImport} onClose={() => setShowImport(false)} />
        </div>
      )}

      {/* Campaigns panel */}
      {showAllCampaigns && (
        <div style={{ padding: "16px 24px", borderBottom: "1px solid #1a3040", animation: "fadeIn 0.2s" }}>
          <CampaignManager data={data} setData={(d) => { setData(d); saveData(d); }} />
        </div>
      )}

      {/* Salesperson Tabs */}
      {data.salespeople.length > 0 && (
        <div style={{ background: "#0a1628", borderBottom: "1px solid #1a3040", padding: "0 24px", display: "flex", gap: 0, overflowX: "auto" }}>
          {data.salespeople.map(sp => (
            <button key={sp.id} onClick={() => { setCurrentSP(sp.id); setView("grid"); setSelectedAffiliate(null); setSelectedAccount(null); }}
              style={{
                padding: "12px 24px", background: "none", border: "none",
                borderBottom: `2px solid ${currentSP === sp.id ? "#7ec8a0" : "transparent"}`,
                color: currentSP === sp.id ? "#d0e8dc" : "#5a7a8a",
                fontSize: 13, fontWeight: currentSP === sp.id ? 600 : 400, cursor: "pointer", whiteSpace: "nowrap",
              }}>
              {sp.name}
              <span style={{ marginLeft: 6, fontSize: 10, color: "#3a5a6a" }}>
                ({data.accounts.filter(a => a.salesperson === sp.id).length})
              </span>
            </button>
          ))}
        </div>
      )}

      {/* Main Content */}
      <div style={{ maxWidth: 1200, margin: "0 auto", padding: 24 }}>
        {data.salespeople.length === 0 ? (
          <div style={{ textAlign: "center", padding: "60px 0", animation: "fadeIn 0.4s" }}>
            <div style={{ fontSize: 48, marginBottom: 16, opacity: 0.3 }}>📊</div>
            <div style={{ fontSize: 18, color: "#5a7a8a", marginBottom: 8 }}>No data yet</div>
            <div style={{ fontSize: 13, color: "#3a5a6a", marginBottom: 24 }}>Import a CSV with your salesperson and account data to get started.</div>
            <button onClick={() => setShowImport(true)} style={{ padding: "10px 24px", background: "linear-gradient(135deg, #1e6f5c, #27ae60)", border: "none", borderRadius: 6, color: "#fff", fontSize: 14, fontWeight: 600 }}>Import CSV</button>
          </div>
        ) : (
          <div style={{ animation: "fadeIn 0.3s" }}>
            {view === "grid" && <AffiliateGrid accounts={spAccounts} onSelectAffiliate={handleSelectAffiliate} />}
            {view === "affiliate" && selectedAffiliate && (
              <AffiliateDetail brandName={selectedAffiliate} accounts={spAccounts} onSelectAccount={handleSelectAccount} onBack={handleBackToGrid} />
            )}
            {view === "account" && selectedAccount && (
              <AccountDetail accountCik={selectedAccount} data={data} setData={(d) => { setData(d); }} onBack={handleBackToAffiliate} />
            )}
          </div>
        )}
      </div>
    </div>
  );
}

// ============================================================
// APP ROOT
// ============================================================
function App() {
  const [authed, setAuthed] = useState(sessionStorage.getItem("analyst_hub_auth") === "true");
  const [data, setData] = useState(loadData);

  const handleLogin = (importedData) => {
    setAuthed(true);
    if (importedData) {
      const merged = { ...loadData() };
      importedData.salespeople.forEach(sp => {
        if (!merged.salespeople.find(s => s.name === sp.name)) merged.salespeople.push(sp);
      });
      importedData.accounts.forEach(acct => {
        const spName = importedData.salespeople.find(s => s.id === acct.salesperson)?.name;
        const mergedSP = merged.salespeople.find(s => s.name === spName);
        if (!merged.accounts.find(a => a.cik === acct.cik)) {
          merged.accounts.push({ ...acct, salesperson: mergedSP?.id || acct.salesperson });
        }
      });
      setData(merged);
      saveData(merged);
    }
  };

  const handleLogout = () => {
    sessionStorage.removeItem("analyst_hub_auth");
    setAuthed(false);
  };

  if (!authed) return <LoginPage onLogin={handleLogin} />;
  return <Dashboard data={data} setData={setData} onLogout={handleLogout} />;
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
